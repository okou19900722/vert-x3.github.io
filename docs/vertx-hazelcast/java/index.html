<!DOCTYPE html>
<html lang="en">
<head>
  <title>Hazelcast Cluster Manager - Vert.x</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name="description">
  <link href="https://vertx.tk/stylesheets/docs.css" media="screen" rel="stylesheet">
  <link href="https://vertx.tk/stylesheets/font-awesome.min.css" media="screen" rel="stylesheet">
  <link href="https://vertx.tk/javascripts/styles/rainbow.min.css" media="screen" rel="stylesheet">
  <!-- IE 6-8 support of HTML 5 elements -->
  <!--[if lt IE 9]>
  <script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script>
  <![endif]-->

  <link rel="apple-touch-icon" sizes="57x57" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="https://vertx.tk/assets/favicons/vertx-favicon-7/manifest.json">
  <link rel="mask-icon" href="https://vertx.tk/assets/favicons/vertx-favicon-7/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#7d3194">
  <meta name="msapplication-TileImage" content="https://vertx.tk/assets/favicons/vertx-favicon-7/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel="stylesheet" type="text/css">
  <link rel="alternate" type="application/rss+xml" title="RSS"
     href="https://vertx.tk/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');
  </script>
  <style>
    .page-link-to-github {
      position: relative;
      z-index: 1;
      display: inline-block;
      border: 1px solid #782B90;
      border-radius: 5px;
      color: #782B90;
      font-size: 12px;
      padding: 4px 10px;
      text-decoration: none;
      background-color: #ffffff;
    }
    .page-link-to-github:hover {
      color: #ffffff;
      border-color: #ffffff;
      background-color: #782B90;
    }

    .page-link-to-github .github-icon {
      position: absolute;
      display: inline-block;
      width: 20px;
      height: 20px;
      /*background-position: -50px 0*/
      background: url('https://vertx.tk/assets/github.png') no-repeat 0 0;
    }

    @media (-webkit-min-device-pixel-ratio: 2),(min-resolution:192dpi) {
      .page-link-to-github .github-icon {
        background-image:url('https://vertx.tk/assets/github@2x.png');
        background-size: 150px auto
      }
    }

    .page-link-to-github:hover .github-icon {
      /*background-position: 0 0*/
      background-position: -100px 0
    }
    .text {
      text-decoration: underline
    }
    .page-link-to-github .text {
      padding-left: 27px
    }
    .text {
      padding-right: 8px
    }
    .page-link-to-github {
      float: right;
      top: 4px
    }

  </style>
</head>
<body>

<a href="http://www.reactivemanifesto.org/" id="reactive-manifesto-banner">
  <img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000"
    src="https://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png">
</a>

<a id="skippy" class="sr-only sr-only-focusable" href="#content"><div class="container"><span class="skiplink-text">Skip to main content</span></div></a>

<header class="navbar navbar-default navbar-static-top" id="top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#vertx-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="https://vertx.tk/" class="navbar-brand"><img alt="Brand" src="https://vertx.tk/assets/logo-sm.png"></a>
    </div>
    <nav class="collapse navbar-collapse" id="vertx-navbar-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://start.vertx.io">Starter</a></li>
        <li><a href="https://vertx.io">官网</a></li>
        <li><a href="https://vertx.tk/download/">下载</a></li>
        <li><a href="https://vertx.tk/docs/">文档</a></li>
        <li><a href="https://github.com/vert-x3/wiki/wiki">维基</a></li>
        <li><a href="https://vertx.tk/community/">社区</a></li>
        <li><a href="https://vertx.tk/materials/">资料</a></li>
        <li><a href="https://vertx.tk/blog/">博客</a></li>
      </ul>
    </nav>
  </div>
</header>



  <div class="page-header" id="content">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1>Hazelcast Cluster Manager</h1>
          
        </div>
      </div>
    </div>
  </div>



<div id="content">
  <div class="container docs-content">
    <div class="row">
      <div class="col-sm-12 col-md-push-9 col-md-3 hidden-xs hidden-sm">
        <div id="sidebar" data-spy="affix">
          <ul class="sectlevel1">
<li><a href="#_使用_hazelcast_cluster_manager">使用 Hazelcast cluster manager</a></li>
<li><a href="#configcluster">配置 Hazelcast cluster manager</a></li>
<li><a href="#_使用已存在的_hazelcast_集群">使用已存在的 Hazelcast 集群</a>
<ul class="sectlevel2">
<li><a href="#_changing_timeout_for_failed_nodes">Changing timeout for failed nodes</a></li>
</ul>
</li>
<li><a href="#_使用_hazelcast_async_methods">使用 Hazelcast async methods</a></li>
<li><a href="#_故障排除">故障排除</a>
<ul class="sectlevel2">
<li><a href="#_机器禁用组播">机器禁用组播</a></li>
<li><a href="#_使用错误的网络接口">使用错误的网络接口</a></li>
<li><a href="#_使用vpn">使用VPN</a></li>
<li><a href="#_组播不可用">组播不可用</a></li>
<li><a href="#_开启日志">开启日志</a></li>
</ul>
</li>
<li><a href="#_hazelcast_日志配置">Hazelcast 日志配置</a></li>
<li><a href="#_使用其他_hazelcast_版本">使用其他 Hazelcast 版本</a></li>
<li><a href="#_configuring_for_kubernetes">Configuring for Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_rolling_updates">Rolling updates</a></li>
</ul>
</li>
</ul>
        </div>
      </div>
      <div class="col-sm-12 col-md-pull-3 col-md-9">
        <div class="toc hidden-md hidden-lg">
          <h2>Table of Contents</h2>
          <ul class="sectlevel1">
<li><a href="#_使用_hazelcast_cluster_manager">使用 Hazelcast cluster manager</a></li>
<li><a href="#configcluster">配置 Hazelcast cluster manager</a></li>
<li><a href="#_使用已存在的_hazelcast_集群">使用已存在的 Hazelcast 集群</a>
<ul class="sectlevel2">
<li><a href="#_changing_timeout_for_failed_nodes">Changing timeout for failed nodes</a></li>
</ul>
</li>
<li><a href="#_使用_hazelcast_async_methods">使用 Hazelcast async methods</a></li>
<li><a href="#_故障排除">故障排除</a>
<ul class="sectlevel2">
<li><a href="#_机器禁用组播">机器禁用组播</a></li>
<li><a href="#_使用错误的网络接口">使用错误的网络接口</a></li>
<li><a href="#_使用vpn">使用VPN</a></li>
<li><a href="#_组播不可用">组播不可用</a></li>
<li><a href="#_开启日志">开启日志</a></li>
</ul>
</li>
<li><a href="#_hazelcast_日志配置">Hazelcast 日志配置</a></li>
<li><a href="#_使用其他_hazelcast_版本">使用其他 Hazelcast 版本</a></li>
<li><a href="#_configuring_for_kubernetes">Configuring for Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_rolling_updates">Rolling updates</a></li>
</ul>
</li>
</ul>
        </div>

  <a href="https://github.com/okou19900722/vertx-web-site-translation-chinese/tree/master/vertx-translation-stack/vertx-hazelcast-translation"
     class="page-link-to-github"
     target="_blank"
     title="Edit this page on GitHub">
    <i class="github-icon"></i>
    <span class="text">编辑本页</span>
  </a>

        <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><code>HazelcastClusterManager</code> 是基于 <a href="http://hazelcast.org">Hazelcast</a> 实现 。</p>
</div>
<div class="paragraph">
<p>它是Vert.x 中集群管理器中的默认实现。由于 Vert.x 集群管理的可插拔性，也可轻易切换至其它的集群管理器。</p>
</div>
<div class="paragraph">
<p>This implementation is packaged inside:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maven (在 <code>pom.xml</code> 文件中):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;io.vertx&lt;/groupId&gt;
 &lt;artifactId&gt;vertx-hazelcast&lt;/artifactId&gt;
 &lt;version&gt;3.6.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Gradle (在 <code>build.gradle</code> 文件中):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">compile 'io.vertx:vertx-hazelcast:3.6.0'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vert.x 集群管理器包含以下几个功能：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>发现并管理集群中的节点</p>
</li>
<li>
<p>管理集群端的主题订阅清单（这样就可以轻松得知集群中的那些节点订阅了那些 EventBus 地址）</p>
</li>
<li>
<p>分布式 Map 支持</p>
</li>
<li>
<p>分布式锁</p>
</li>
<li>
<p>分布式计数器</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vert.x 集群器并不处理节点之间的通信，在 Vert.x 中节点中的通信是直接由 TCP 链接处理的。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_使用_hazelcast_cluster_manager">使用 Hazelcast cluster manager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>如果通过命令行来使用 Vert.x，对应集群管理器 <code>jar</code> 包( <code>vertx-hazelcast-3.6.0</code> )应该在 Vert.x 中安装包中。</p>
</div>
<div class="paragraph">
<p>如果在 <code>Maven</code> 或者 <code>Gradle</code> 工程中使用 Vert.x ，只需要在工程依赖中加上相应的 <code>ClusterManager</code> 实现依赖：<code>io.vertx:vertx-hazelcast:3.6.0</code>。</p>
</div>
<div class="paragraph">
<p>如果 <code>HazelcastClusterManager</code> 在 <code>classpath</code> 中，Vert.x将自动检测到，并将其作为集群管理。需要注意的是，要确保 Vert.x 的 <code>classpath</code> 中没有其它的 <code>ClusterManager</code> 实现 <code>jar</code> 包。</p>
</div>
<div class="paragraph">
<p>当然在内嵌 Vert.x 时，通过编程的方式创建 Vert.x 集群模式实例，调用 <code>setClusterManager</code> 方法显式指定集群管理器。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ClusterManager mgr = new HazelcastClusterManager();

VertxOptions options = new VertxOptions().setClusterManager(mgr);

Vertx.clusteredVertx(options, res -&gt; {
  if (res.succeeded()) {
    Vertx vertx = res.result();
  } else {
    // failed!
  }
});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configcluster">配置 Hazelcast cluster manager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>通常情况下，集群管理器的相关配置是由打包的jar中的默认配置文件
<a href="https://github.com/vert-x3/vertx-hazelcast/blob/master/src/main/resources/default-cluster.xml"><code>default-cluster.xml</code></a>
决定的。</p>
</div>
<div class="paragraph">
<p>如果要覆盖此配置，可以在 <code>classpath</code> 中添加一个 <code>cluster.xml</code> 文件。如果想在 fat jar 中内嵌 <code>cluster.xml</code> ，
此文件必须在 fat jar 的根目录中。如果此文件是一个外部文件，则必须将其添加至 <code>classpath</code> 中。举个例子：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># cluster.xml 在当前路径中
java -jar ... -cp . -cluster
vertx run MyVerticle -cp . -cluster

# cluster.xml 在 conf 目录中
java -jar ... -cp conf -cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>还有一种方式来覆盖默认的配置文件，那就是利用系统配置 <code>vertx.hazelcast.config</code> 来实现：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># 指定一个外部文件为自定义配置文件
java -Dvertx.hazelcast.config=./config/my-cluster-config.xml -jar ... -cluster

# 从 classpath 中加载一个文件为自定义配置文件
java -Dvertx.hazelcast.config=classpath:my/package/config/my-cluster-config.xml -jar ... -cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果 <code>vertx.hazelcast.config</code> 值不为空时，将覆盖 <code>classpath</code> 中所有的 <code>cluster.xml</code> 文件，
但是如果加载 <code>vertx.hazelcast.config</code> 失败时，系统将选取 <code>classpath</code> 任意一个 <code>cluster.xml</code> ，甚至直接使用默认配置。</p>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<div class="title">Caution</div>
</td>
<td class="content">
Vert.x 并不支持 -Dhazelcast.config 设置方式，请不要使用。
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The xml file is a Hazelcast configuration file and is described in detail in the documentation on the Hazelcast
web-site.</p>
</div>
<div class="paragraph">
<p>同时也可以通过编程的形式达到配置的目的：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Config hazelcastConfig = new Config();

// Now set some stuff on the config (omitted)

ClusterManager mgr = new HazelcastClusterManager(hazelcastConfig);

VertxOptions options = new VertxOptions().setClusterManager(mgr);

Vertx.clusteredVertx(options, res -&gt; {
  if (res.succeeded()) {
    Vertx vertx = res.result();
  } else {
    // failed!
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Hazelcast支持多种不同的传输协议，包括组播和TCP。默认配置中采用组播传输协议，因此您必须在网络上启用组播才能使其工作。</p>
</div>
<div class="paragraph">
<p>具体详细配置，请参阅 <a href="http://hazelcast.org">Hazelcast 文档</a> 。
For full documentation on how to configure the transport differently or use a different transport please consult the
Hazelcast documentation.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_使用已存在的_hazelcast_集群">使用已存在的 Hazelcast 集群</h2>
<div class="sectionbody">
<div class="paragraph">
<p>可以在集群管理器通过设置 <code>HazelcastInstance</code> 来复用现有集群：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ClusterManager mgr = new HazelcastClusterManager(hazelcastInstance);
VertxOptions options = new VertxOptions().setClusterManager(mgr);
Vertx.clusteredVertx(options, res -&gt; {
  if (res.succeeded()) {
    Vertx vertx = res.result();
  } else {
    // failed!
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>在这种情况下，Vert.x不是 Hazelcast 群集的所有者，所以不要关闭 Vert.x 时关闭 Hazlecast 集群。</p>
</div>
<div class="paragraph">
<p>请注意，自定义 Hazelcast 实例需要配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;properties&gt;
 &lt;property name="hazelcast.shutdownhook.enabled"&gt;false&lt;/property&gt;
&lt;/properties&gt;
&lt;multimap name="__vertx.subs"&gt;
 &lt;backup-count&gt;1&lt;/backup-count&gt;
&lt;/multimap&gt;
&lt;map name="__vertx.haInfo"&gt;
 &lt;time-to-live-seconds&gt;0&lt;/time-to-live-seconds&gt;
 &lt;max-idle-seconds&gt;0&lt;/max-idle-seconds&gt;
 &lt;eviction-policy&gt;NONE&lt;/eviction-policy&gt;
 &lt;max-size policy="PER_NODE"&gt;0&lt;/max-size&gt;
 &lt;eviction-percentage&gt;25&lt;/eviction-percentage&gt;
 &lt;merge-policy&gt;com.hazelcast.map.merge.LatestUpdateMapMergePolicy&lt;/merge-policy&gt;
&lt;/map&gt;
&lt;semaphore name="__vertx.*"&gt;
 &lt;initial-permits&gt;1&lt;/initial-permits&gt;
&lt;/semaphore&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>IMPORTANT</strong> 当 Vert.x 集群使用 HA（高可用或故障转移）时，请不要使用 Hazelcast 客户端，因为他们不会通知他们何时离开集群，同时有可能丢失数据，还有可能将集群置于不一致的状态。更多情况请翻阅 <a href="https://github.com/vert-x3/vertx-hazelcast/issues/24">Issue 24</a></p>
</div>
<div class="paragraph">
<p><strong>IMPORTANT</strong> 同时要确保 Hazelcast 集群 先于 Vert.x 集群启动，后于 Vert.x 集群关闭。同时需要禁用 <code>shutdownhook</code> 。参考上述的 xml 配置，或者通过 系统变量来实现。</p>
</div>
<div class="sect2">
<h3 id="_changing_timeout_for_failed_nodes">Changing timeout for failed nodes</h3>
<div class="paragraph">
<p>By default a node will be removed from the cluster if Hazelcast didn&#8217;t receive a heartbeat for 300 seconds. To change
this value <code>hazelcast.max.no.heartbeat.seconds</code> system property such as in:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-Dhazelcast.max.no.heartbeat.seconds=5</pre>
</div>
</div>
<div class="paragraph">
<p>Afterwards a node will be removed from the cluster after 5 seconds without a heartbeat.</p>
</div>
<div class="paragraph">
<p>See <a href="http://docs.hazelcast.org/docs/3.6/manual/html-single/index.html#system-properties">Hazelcast
system-properties</a> and
<a href="http://docs.hazelcast.org/docs/3.6/manual/html-single/index.html#configuring-with-system-properties">configuring Hazelcast
with system properties</a> for the other properties you can configure.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_使用_hazelcast_async_methods">使用 Hazelcast async methods</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hazelcast 中的 <code>IMap</code> 、 <code>IAtomicLong</code> 接口(数据结构) 均有异步调用方法，
其返回值为 <code>ICompletableFuture&lt;V&gt;</code>，这与 Vert.x 的线程模型完美契合。
但是即使这些接口已经存在一段时间，却没有通过 <code>HazelcastInstance</code> 公共 API 暴露。</p>
</div>
<div class="paragraph">
<p>默认情况下，<code>HazelcastClusterManager</code> 使用公共 API。当在程序启动时，设置选项`-Dvertx.hazelcast.async-api=true` ，
将代表系统在与 Hazelcast 集群通讯交互时，将采用 Hazelcast async API 。
这意味着，<code>Counter</code> 计数操作、<code>AsyncMap`的 `get</code> <code>put</code> <code>remove</code> 操作都将通过 Vert.x EventLoop 线程来执行，
而不是通过 Woker 线程的 <code>vertx.executeBlocking</code> 执行。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_故障排除">故障排除</h2>
<div class="sectionbody">
<div class="paragraph">
<p>如果默认的组播配置不能正常运行，通常有以下原因：</p>
</div>
<div class="sect2">
<h3 id="_机器禁用组播">机器禁用组播</h3>
<div class="paragraph">
<p>MacOS 默认禁用组播。Google一下启用组播。</p>
</div>
</div>
<div class="sect2">
<h3 id="_使用错误的网络接口">使用错误的网络接口</h3>
<div class="paragraph">
<p>如果机器上有多个网络接口（也有可能是在运行 VPN 的情况下），那么 Hazelcast 很有可能是使用了错误的网络接口。</p>
</div>
<div class="paragraph">
<p>为了确保 Hazelcast 使用正确的网络接口，在配置文件中将 <code>interface</code> 设置为指定IP地址，同时确保 enabled 属性设置为 true 。 例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>&lt;interfaces enabled="true"&gt;
 &lt;interface&gt;192.168.1.20&lt;/interface&gt;
&lt;/interfaces&gt;</pre>
</div>
</div>
<div class="paragraph">
<p>当运行集群模式时，需要确保 Vert.x 使用正确的网络接口。
当通过命令行模式时，可以设置 <code>cluster-host</code> 参数：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>vertx run myverticle.js -cluster -cluster-host your-ip-address</pre>
</div>
</div>
<div class="paragraph">
<p>其中 <code>your-ip-address</code> 必须与 Hazelcast 中的配置保持一致。</p>
</div>
<div class="paragraph">
<p>当通过编程模式使用 Vert.x 时，可以调用方法
<code><a href="../../apidocs/io/vertx/core/VertxOptions.html#setClusterHost-java.lang.String-">setClusterHost</a></code> 来设置参数</p>
</div>
</div>
<div class="sect2">
<h3 id="_使用vpn">使用VPN</h3>
<div class="paragraph">
<p>VPN 软件通常通过创建不支持组播的虚拟网络接口来进行工作。在 VPN 环境中，如果 Hazelcast 与 Vert.x 不正确配置的话，VPN 接口将被选择，而不是正确的接口。</p>
</div>
<div class="paragraph">
<p>所以，如果你的软件运行在 VPN 环境中，参考上述章节，设置正确的网络接口。</p>
</div>
</div>
<div class="sect2">
<h3 id="_组播不可用">组播不可用</h3>
<div class="paragraph">
<p>在某些情况下，因为特殊的运行环境，可能无法使用组播。在这种情况下，应该配置其他网络传输，例如在 TCP 上使用 TCP 套接字，在亚马逊云上使用 EC2 。</p>
</div>
<div class="paragraph">
<p>有关 Hazelcast 更多传输方式，以及如何配置它们，请咨询 Hazelcast 文档。</p>
</div>
</div>
<div class="sect2">
<h3 id="_开启日志">开启日志</h3>
<div class="paragraph">
<p>在排除故障时，开启 Hazelcast 日志，将会给予很大的帮助。在 <code>classpath</code> 中添加 <code>vertx-default-jul-logging.properties</code> 文件（默认的JUL记录时），
这是一个标准 java.util.loging（JUL） 配置文件。具体配置如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>com.hazelcast.level=INFO</pre>
</div>
</div>
<div class="paragraph">
<p>或者</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java.util.logging.ConsoleHandler.level=INFO
java.util.logging.FileHandler.level=INFO</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_hazelcast_日志配置">Hazelcast 日志配置</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hazelcast 的日志默认采用 JDK 实现（参考 JUL）。如果想切换至其他日志库，通过设置 <code>azelcast.logging.type</code> 即可达到目的。</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-Dhazelcast.logging.type=slf4j</pre>
</div>
</div>
<div class="paragraph">
<p>详细文档请参考 <a href="http://docs.hazelcast.org/docs/3.6.1/manual/html-single/index.html#logging-configuration">hazelcast documentation</a> 。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_使用其他_hazelcast_版本">使用其他 Hazelcast 版本</h2>
<div class="sectionbody">
<div class="paragraph">
<p>当前的 Vert.x HazelcastClusterManager 使用的 Hazelcast 版本为 <code>3.8.2</code> 。如果开发者想使用其他版本的 Hazelcast，需要做以下工作：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>将目标版本的 Hazelcast 依赖添加至 classpath 中</p>
</li>
<li>
<p>如果是 fat jar 的形式，在构建工具中使用正确的版本</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In this later case, you would need in Maven:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;com.hazelcast&lt;/groupId&gt;
 &lt;artifactId&gt;hazelcast&lt;/artifactId&gt;
 &lt;version&gt;ENTER_YOUR_VERSION_HERE&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
 &lt;groupId&gt;io.vertx&lt;/groupId&gt;
 &lt;artifactId&gt;vertx-hazelcast&lt;/artifactId&gt;
 &lt;version&gt;3.6.0&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Depending on the version, you may need to exclude some transitive dependencies.</p>
</div>
<div class="paragraph">
<p>On Gradle, you can achieve the same overloading using:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>dependencies {
compile ("io.vertx:vertx-hazelcast:3.6.0"){
  exclude group: 'com.hazelcast', module: 'hazelcast'
}
compile "com.hazelcast:hazelcast:ENTER_YOUR_VERSION_HERE"
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_for_kubernetes">Configuring for Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On Kubernetes, Hazelcast should be configured to use the <a href="https://github.com/hazelcast/hazelcast-kubernetes">Hazelcast Kubernetes</a> plugin.</p>
</div>
<div class="paragraph">
<p>First, add the <code>io.vertx:vertx-hazelcast:${vertx.version}</code> and <code>com.hazelcast:hazelcast-kubernetes:${hazelcast-kubernetes-version}</code>
dependencies to your project. With Maven it looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;io.vertx&lt;/groupId&gt;
 &lt;artifactId&gt;vertx-hazelcast&lt;/artifactId&gt;
 &lt;version&gt;${vertx.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
 &lt;groupId&gt;com.hazelcast&lt;/groupId&gt;
 &lt;artifactId&gt;hazelcast-kubernetes&lt;/artifactId&gt;
 &lt;version&gt;${hazelcast-kubernetes-version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The second step is to configure the discovery plugin inside of your Hazelcast configuration, by either providing a custom
<code>cluster.xml</code> file or programmatically, as described in <a href="#configcluster">配置 Hazelcast cluster manager</a>.</p>
</div>
<div class="paragraph">
<p>The following properties have to be changed / added:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;hazelcast&gt;
 &lt;properties&gt;
   &lt;!-- only necessary prior Hazelcast 3.8 --&gt;
   &lt;property name="hazelcast.discovery.enabled"&gt;true&lt;/property&gt;
 &lt;/properties&gt;

 &lt;network&gt;
   &lt;join&gt;
     &lt;!-- deactivate normal discovery --&gt;
     &lt;multicast enabled="false"/&gt;
     &lt;tcp-ip enabled="false" /&gt;

     &lt;!-- activate the Kubernetes plugin --&gt;
     &lt;discovery-strategies&gt;
       &lt;discovery-strategy enabled="true"
           class="com.hazelcast.kubernetes.HazelcastKubernetesDiscoveryStrategy"&gt;

         &lt;properties&gt;
           &lt;!-- configure discovery service API lookup --&gt;
           &lt;property name="service-dns"&gt;MY-SERVICE-DNS-NAME&lt;/property&gt;
           &lt;property name="service-dns-timeout"&gt;10&lt;/property&gt;
         &lt;/properties&gt;
       &lt;/discovery-strategy&gt;
     &lt;/discovery-strategies&gt;
   &lt;/join&gt;
 &lt;/network&gt;
&lt;/hazelcast&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>MY-SERVICE-DNS-NAME</code> value must be a <strong>headless</strong> Kubernetes service name that will be used by Hazelcast to identify all cluster members.
The format for this field is <code>MY-SERVICE-NAME.MY-NAMESPACE.svc.cluster.local</code>.
A headless service can be created with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: v1
kind: Service
metadata:
 namespace: MY-NAMESPACE
 name: MY-SERVICE-NAME
spec:
 selector:
   component: MY-SERVICE-NAME
 clusterIP: None
 ports:
 - name: hz-port-name
   port: 5701
   protocol: TCP</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, attach the <code>component</code> label to all deployments that should be part of the cluster:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">apiVersion: extensions/v1beta1
kind: Deployment
metadata:
 namespace: MY-NAMESPACE
spec:
 template:
   metadata:
     labels:
       component: MY-SERVICE-NAME</code></pre>
</div>
</div>
<div class="paragraph">
<p>Further configuration details are available on the <a href="https://github.com/hazelcast/hazelcast-kubernetes">Hazelcast Kubernetes Plugin page</a>.</p>
</div>
<div class="sect2">
<h3 id="_rolling_updates">Rolling updates</h3>
<div class="paragraph">
<p>During rolling updates, it is recommended to replace pods one by one.</p>
</div>
<div class="paragraph">
<p>To do so, we must configure Kubernetes to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>never start more than one new pod at once</p>
</li>
<li>
<p>forbid more than one unavailable pod during the process</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spec:
 strategy:
   type: Rolling
   rollingParams:
     updatePeriodSeconds: 10
     intervalSeconds: 20
     timeoutSeconds: 600
     maxUnavailable: 1 <b class="conum">(1)</b>
     maxSurge: 1 <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>the maximum number of pods that can be unavailable during the update process</p>
</li>
<li>
<p>the maximum number of pods that can be created over the desired number of pods</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Also, the pod readiness probe must take the cluster state into account.
Indeed, when a node joins or leaves the cluster, Hazelcast rebalances the data across members, and it is better to avoid concurrent state transfers.
When the state transfer completes, the cluster goes back to a safe state.</p>
</div>
<div class="paragraph">
<p>The readiness probe can be implemented with <a href="../../vertx-health-check/java/">Vert.x Health Checks</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Handler&lt;Future&lt;Status&gt;&gt; procedure = ClusterHealthCheck.createProcedure(vertx);
HealthChecks checks = HealthChecks.create(vertx).register("cluster-health", procedure);</code></pre>
</div>
</div>
<div class="paragraph">
<p>After creation, it can be exposed over HTTP with a <a href="../../vertx-web/java/">Vert.x Web</a> router handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Router router = Router.router(vertx);
router.get("/readiness").handler(HealthCheckHandler.createWithHealthChecks(checks));</code></pre>
</div>
</div>
</div>
</div>
</div>
        

        
          <div id="footer">
            <div id="footer-text">
              
                上次更新时间 2018-12-05 20:05:27 CST
              
              
            </div>
          </div>
        
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse Vert.x</h2>
        <ul class="list-unstyled">
          <li><a href="https://vertx.tk/">主页</a></li>
          <li><a href="https://vertx.tk/download/">下载</a></li>
          <li><a href="https://vertx.tk/docs/">文档</a></li>
          <li><a href="https://github.com/vert-x3/wiki/wiki">维基</a></li>
          <li><a href="https://vertx.tk/blog/">博客</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Community</h2>
        <ul class="list-unstyled">
          <li><a href="https://vertx.tk/community/">帮助 &amp; 贡献者</a></li>
          <li><a href="https://vertx.tk/materials/">学习资料</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx">User Group</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx-dev">Developer Group</a></li>
          <li><a href="//shang.qq.com/wpa/qunwpa?idkey=587f58cacb9557e3291b46098e0fe09427b98a1c0f866da23c04c2762bc7e2ad">QQ群</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse</h2>
        <ul class="list-unstyled">
          <li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li>
          <li><a href="https://eclipse.org/legal/privacy.php">Privacy Policy</a></li>
          <li><a href="https://eclipse.org/legal/termsofuse.php">Terms of Use</a></li>
          <li><a href="https://eclipse.org/legal/copyright.php">Copyright Agent</a></li>
          <li><a href="http://www.eclipse.org/legal">Legal Resources</a></li>
        </ul>
      </div>

      <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright">
        <p>Eclipse Vert.x is open source and dual-licensed under the <a href="http://www.eclipse.org/legal/epl-v20.html">Eclipse Public License 2.0</a> and <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License 2.0</a>.</p>
        <p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>
        Design by <a href="https://www.michel-kraemer.com">Michel Kr&auml;mer</a>.</p>
        <div class="row">
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2">
            <a href="http://eclipse.org">
            <img class="logo eclipse-logo" src="https://vertx.tk/assets/eclipse_logo_grey_small.png" width="204" height="48">
            </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0">
            <a href="http://cloudbees.com">
            <img class="logo cloudbees-logo" src="https://vertx.tk/assets/Button-Built-on-CB-1-grey.png" width="180" height="48">
           </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler">
            <a href="http://www.ej-technologies.com/products/jprofiler/overview.html"
            style="text-decoration:none">
            <img class="logo jprofiler-logo" src="https://vertx.tk/assets/jprofiler-logo.png" width="48" height="48"><span class="jprofiler-logo">&nbsp; JPROFILER</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://vertx.tk/javascripts/bootstrap.min.js"></script>
<script src="https://vertx.tk/javascripts/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script src="https://vertx.tk/javascripts/sidebar.js"></script>


<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});
</script>
</body>
</html>

