<!DOCTYPE html>
<html lang="en">
<head>
  <title>Securing and controlling access - Vert.x</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name="description">
  <link href="https://okou19900722.gitee.io/cn.vertx.tk//stylesheets/docs.css" media="screen" rel="stylesheet">
  <link href="https://okou19900722.gitee.io/cn.vertx.tk//stylesheets/font-awesome.min.css" media="screen" rel="stylesheet">
  <link href="https://okou19900722.gitee.io/cn.vertx.tk//javascripts/styles/rainbow.min.css" media="screen" rel="stylesheet">
  <!-- IE 6-8 support of HTML 5 elements -->
  <!--[if lt IE 9]>
  <script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script>
  <![endif]-->

  <link rel="apple-touch-icon" sizes="57x57" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/manifest.json">
  <link rel="mask-icon" href="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#7d3194">
  <meta name="msapplication-TileImage" content="https://okou19900722.gitee.io/cn.vertx.tk//assets/favicons/vertx-favicon-7/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel="stylesheet" type="text/css">
  <link rel="alternate" type="application/rss+xml" title="RSS"
     href="https://okou19900722.gitee.io/cn.vertx.tk//feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');
  </script>
  <style>
    .page-link-to-github {
      position: relative;
      z-index: 1;
      display: inline-block;
      border: 1px solid #782B90;
      border-radius: 5px;
      color: #782B90;
      font-size: 12px;
      padding: 4px 10px;
      text-decoration: none;
      background-color: #ffffff;
    }
    .page-link-to-github:hover {
      color: #ffffff;
      border-color: #ffffff;
      background-color: #782B90;
    }

    .page-link-to-github .github-icon {
      position: absolute;
      display: inline-block;
      width: 20px;
      height: 20px;
      /*background-position: -50px 0*/
      background: url('https://okou19900722.gitee.io/cn.vertx.tk//assets/github.png') no-repeat 0 0;
    }

    @media (-webkit-min-device-pixel-ratio: 2),(min-resolution:192dpi) {
      .page-link-to-github .github-icon {
        background-image:url('https://okou19900722.gitee.io/cn.vertx.tk//assets/github@2x.png');
        background-size: 150px auto
      }
    }

    .page-link-to-github:hover .github-icon {
      /*background-position: 0 0*/
      background-position: -100px 0
    }
    .text {
      text-decoration: underline
    }
    .page-link-to-github .text {
      padding-left: 27px
    }
    .text {
      padding-right: 8px
    }
    .page-link-to-github {
      float: right;
      top: 4px
    }

  </style>
</head>
<body>

<a href="http://www.reactivemanifesto.org/" id="reactive-manifesto-banner">
  <img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000"
    src="https://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png">
</a>

<a id="skippy" class="sr-only sr-only-focusable" href="#content"><div class="container"><span class="skiplink-text">Skip to main content</span></div></a>

<header class="navbar navbar-default navbar-static-top" id="top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#vertx-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="https://okou19900722.gitee.io/cn.vertx.tk//" class="navbar-brand"><img alt="Brand" src="https://okou19900722.gitee.io/cn.vertx.tk//assets/logo-sm.png"></a>
    </div>
    <nav class="collapse navbar-collapse" id="vertx-navbar-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://start.vertx.io">Starter</a></li>
        <li><a href="https://vertx.io">官网</a></li>
        <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//download/">下载</a></li>
        <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//docs/">文档</a></li>
        <li><a href="https://github.com/vert-x3/wiki/wiki">维基</a></li>
        <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//community/">社区</a></li>
        <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//materials/">资料</a></li>
        <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//blog/">博客</a></li>
      </ul>
    </nav>
  </div>
</header>



  <div class="page-header" id="content">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1>Securing and controlling access</h1>
          
        </div>
      </div>
    </div>
  </div>



<div id="content">
  <div class="container docs-content">
    <div class="row">
      <div class="col-sm-12 col-md-push-9 col-md-3 hidden-xs hidden-sm">
        <div id="sidebar" data-spy="affix">
          <ul class="sectlevel1">
<li><a href="#_https_support_in_vert_x">HTTPS support in Vert.x</a></li>
<li><a href="#_access_control_and_authentication">Access control and authentication</a>
<ul class="sectlevel2">
<li><a href="#_refactoring_the_jdbc_configuration">Refactoring the JDBC configuration</a></li>
<li><a href="#_adding_jdbc_authentication_to_routes">Adding JDBC authentication to routes</a></li>
<li><a href="#_supporting_features_based_on_roles">Supporting features based on roles</a></li>
<li><a href="#_populating_the_database_with_user_and_role_data">Populating the database with user and role data</a></li>
</ul>
</li>
<li><a href="#_authenticating_web_api_requests_with_jwt">Authenticating web API requests with JWT</a>
<ul class="sectlevel2">
<li><a href="#_adding_jwt_support">Adding JWT support</a></li>
<li><a href="#_using_jwt_tokens">Using JWT tokens</a></li>
<li><a href="#_adapting_the_api_test_fixture">Adapting the API test fixture</a></li>
</ul>
</li>
</ul>
        </div>
      </div>
      <div class="col-sm-12 col-md-pull-3 col-md-9">
        <div class="toc hidden-md hidden-lg">
          <h2>Table of Contents</h2>
          <ul class="sectlevel1">
<li><a href="#_https_support_in_vert_x">HTTPS support in Vert.x</a></li>
<li><a href="#_access_control_and_authentication">Access control and authentication</a>
<ul class="sectlevel2">
<li><a href="#_refactoring_the_jdbc_configuration">Refactoring the JDBC configuration</a></li>
<li><a href="#_adding_jdbc_authentication_to_routes">Adding JDBC authentication to routes</a></li>
<li><a href="#_supporting_features_based_on_roles">Supporting features based on roles</a></li>
<li><a href="#_populating_the_database_with_user_and_role_data">Populating the database with user and role data</a></li>
</ul>
</li>
<li><a href="#_authenticating_web_api_requests_with_jwt">Authenticating web API requests with JWT</a>
<ul class="sectlevel2">
<li><a href="#_adding_jwt_support">Adding JWT support</a></li>
<li><a href="#_using_jwt_tokens">Using JWT tokens</a></li>
<li><a href="#_adapting_the_api_test_fixture">Adapting the API test fixture</a></li>
</ul>
</li>
</ul>
        </div>

  <a href="https://github.com/okou19900722/vertx-web-site-translation-chinese/tree/master/vertx-translation-stack/guide-for-java-devs-translation"
     class="page-link-to-github"
     target="_blank"
     title="Edit this page on GitHub">
    <i class="github-icon"></i>
    <span class="text">编辑本页</span>
  </a>

        <div id="preamble">
<div class="sectionbody">
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<div class="title">Tip</div>
</td>
<td class="content">
The corresponding source code is in the <code>step-7</code> folder of the guide repository.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Securing and controlling access is easy to do with Vert.x.
In this section, we will:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>move from HTTP to HTTPS, and</p>
</li>
<li>
<p>add user authentication with group-based privileges to the web application, and</p>
</li>
<li>
<p>control access to the web API using <a href="https://jwt.io/"><em>JSON web tokens</em> (JWT)</a>.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_https_support_in_vert_x">HTTPS support in Vert.x</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vert.x provides support for SSL-encrypted network connections.
It is common to expose HTTP servers in production through a front HTTP server / proxy like Nginx, and have it use HTTPS for incoming connections.
Vert.x can also expose HTTPS by itself, so as to provide end-to-end encryption.</p>
</div>
<div class="paragraph">
<p>Certificates can be stored in Java <em>KeyStore</em> files.
You will likely need a <em>self-signed certificate</em> for testing purposes, and here is how to create one in a <code>server-keystore.jks</code> KeyStore where the password is <code>secret</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">keytool -genkey \
  -alias test \
  -keyalg RSA \
  -keystore server-keystore.jks \
  -keysize 2048 \
  -validity 360 \
  -dname CN=localhost \
  -keypass secret \
  -storepass secret</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can then change the HTTP server creation to pass a <code>HttpServerOptions</code> object to specify that we want SSL, and to point to our KeyStore file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">HttpServer server = vertx.createHttpServer(new HttpServerOptions()
  .setSsl(true)
  .setKeyStoreOptions(new JksOptions()
    .setPath("server-keystore.jks")
    .setPassword("secret")));</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can point a web browser to <a href="https://localhost:8080/" class="bare">https://localhost:8080/</a>, but since the certificate is a self-signed one any good browser will rightfully yield a security warning:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/images/invalid-cert.png" alt="invalid cert">
</div>
</div>
<div class="paragraph">
<p>Last but not least, we need to update the test case in <code>ApiTest</code> since the original code was made for issuing HTTP requests with the web client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">webClient = WebClient.create(vertx, new WebClientOptions()
  .setDefaultHost("localhost")
  .setDefaultPort(8080)
  .setSsl(true) <b class="conum">(1)</b>
  .setTrustOptions(new JksOptions().setPath("server-keystore.jks").setPassword("secret"))); <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Ensures SSL.</p>
</li>
<li>
<p>Since the certificate is self-signed, we need to explicitly trust it otherwise the web client connections will fail just like a web browser would.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_access_control_and_authentication">Access control and authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vert.x provides a wide range of options for doing authentication and authorization.
The officially supported modules cover JDBC, MongoDB, Apache Shiro, <code>htdigest</code> files, OAuth2 with well-known providers and JWT (JSON web tokens).</p>
</div>
<div class="paragraph">
<p>While the next section will cover JWT, this one focuses on using JDBC-based authentication, reusing the wiki database.</p>
</div>
<div class="paragraph">
<p>The goal is to require users to authenticate for using the wiki, and have role-based permissions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>having no role only allows reading pages,</p>
</li>
<li>
<p>having a <em>writer</em> role allows editing pages,</p>
</li>
<li>
<p>having an <em>editor</em> role allows creating, editing and deleting pages,</p>
</li>
<li>
<p>having an <em>admin</em> role is equivalent to having all possible roles.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_refactoring_the_jdbc_configuration">Refactoring the JDBC configuration</h3>
<div class="paragraph">
<p>In the previous steps, only the database verticle and service where aware of the JDBC configuration.
Now the HTTP service vertice also needs to share the same JDBC access.</p>
</div>
<div class="paragraph">
<p>To do that we extract configuration parameters and default values to an interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package io.vertx.guides.wiki;

public interface DatabaseConstants {

  String CONFIG_WIKIDB_JDBC_URL = "wikidb.jdbc.url";
  String CONFIG_WIKIDB_JDBC_DRIVER_CLASS = "wikidb.jdbc.driver_class";
  String CONFIG_WIKIDB_JDBC_MAX_POOL_SIZE = "wikidb.jdbc.max_pool_size";

  String DEFAULT_WIKIDB_JDBC_URL = "jdbc:hsqldb:file:db/wiki";
  String DEFAULT_WIKIDB_JDBC_DRIVER_CLASS = "org.hsqldb.jdbcDriver";
  int DEFAULT_JDBC_MAX_POOL_SIZE = 30;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now in <code>WikiDatabaseVerticle</code> we use these constants as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">JDBCClient dbClient = JDBCClient.createShared(vertx, new JsonObject()
  .put("url", config().getString(CONFIG_WIKIDB_JDBC_URL, DEFAULT_WIKIDB_JDBC_URL))
  .put("driver_class", config().getString(CONFIG_WIKIDB_JDBC_DRIVER_CLASS, DEFAULT_WIKIDB_JDBC_DRIVER_CLASS))
  .put("max_pool_size", config().getInteger(CONFIG_WIKIDB_JDBC_MAX_POOL_SIZE, DEFAULT_JDBC_MAX_POOL_SIZE)));</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_adding_jdbc_authentication_to_routes">Adding JDBC authentication to routes</h3>
<div class="paragraph">
<p>The first step is to add the <code>vertx-auth-jdbc</code> module to the Maven dependencies list:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.vertx&lt;/groupId&gt;
  &lt;artifactId&gt;vertx-auth-jdbc&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Back to the <code>HttpServerVerticle</code> class code, we create an authentication provider:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">JDBCClient dbClient = JDBCClient.createShared(vertx, new JsonObject()
  .put("url", config().getString(CONFIG_WIKIDB_JDBC_URL, DEFAULT_WIKIDB_JDBC_URL))
  .put("driver_class", config().getString(CONFIG_WIKIDB_JDBC_DRIVER_CLASS, DEFAULT_WIKIDB_JDBC_DRIVER_CLASS))
  .put("max_pool_size", config().getInteger(CONFIG_WIKIDB_JDBC_MAX_POOL_SIZE, DEFAULT_JDBC_MAX_POOL_SIZE)));

JDBCAuth auth = JDBCAuth.create(vertx, dbClient);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>JDBCAuth</code> object instance is then used to deal with server-side user sessions:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Router router = Router.router(vertx);

router.route().handler(CookieHandler.create());
router.route().handler(BodyHandler.create());
router.route().handler(SessionHandler.create(LocalSessionStore.create(vertx)));
router.route().handler(UserSessionHandler.create(auth));  <b class="conum">(1)</b>

AuthHandler authHandler = RedirectAuthHandler.create(auth, "/login"); <b class="conum">(2)</b>
router.route("/").handler(authHandler);  <b class="conum">(3)</b>
router.route("/wiki/*").handler(authHandler);
router.route("/action/*").handler(authHandler);

router.get("/").handler(this::indexHandler);
router.get("/wiki/:page").handler(this::pageRenderingHandler);
router.post("/action/save").handler(this::pageUpdateHandler);
router.post("/action/create").handler(this::pageCreateHandler);
router.get("/action/backup").handler(this::backupHandler);
router.post("/action/delete").handler(this::pageDeletionHandler);</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We install a user session handler for all routes.</p>
</li>
<li>
<p>This automatically redirects requests to <code>/login</code> when there is no user session for the request.</p>
</li>
<li>
<p>We install <code>authHandler</code> for all routes where authentication is required.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Finally, we need to create 3 routes for displaying a login form, handling login form submissions and logging out users:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">router.get("/login").handler(this::loginHandler);
router.post("/login-auth").handler(FormLoginHandler.create(auth));  <b class="conum">(1)</b>

router.get("/logout").handler(context -&gt; {
  context.clearUser();  <b class="conum">(2)</b>
  context.response()
    .setStatusCode(302)
    .putHeader("Location", "/")
    .end();
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p><code>FormLoginHandler</code> is a helper for processing login submission requests. By default it expects the HTTP POST request to have: <code>username</code> as the login, <code>password</code> as the password, and <code>return_url</code> as the URL to redirect to upon success.</p>
</li>
<li>
<p>Logging out a user is a simple as clearing it from the current <code>RoutingContext</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The code for the <code>loginHandler</code> method is:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private void loginHandler(RoutingContext context) {
  context.put("title", "Login");
  templateEngine.render(context, "templates", "/login.ftl", ar -&gt; {
    if (ar.succeeded()) {
      context.response().putHeader("Content-Type", "text/html");
      context.response().end(ar.result());
    } else {
      context.fail(ar.cause());
    }
  });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The HTML template is placed in <code>src/main/resources/templates/login.ftl</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;#include "header.ftl"&gt;

&lt;div class="row"&gt;

  &lt;div class="col-md-12 mt-1"&gt;
    &lt;form action="/login-auth" method="POST"&gt;
      &lt;div class="form-group"&gt;
        &lt;input type="text" name="username" placeholder="login"&gt;
        &lt;input type="password" name="password" placeholder="password"&gt;
        &lt;input type="hidden" name="return_url" value="/"&gt;
        &lt;button type="submit" class="btn btn-primary"&gt;Login&lt;/button&gt;
      &lt;/div&gt;
    &lt;/form&gt;
  &lt;/div&gt;

&lt;/div&gt;

&lt;#include "footer.ftl"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The login page looks as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/images/login-form.png" alt="login form">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_supporting_features_based_on_roles">Supporting features based on roles</h3>
<div class="paragraph">
<p>Features need to be activated only if the user has sufficient permissions.
In the following screenshot an administrator can create a page and perform a backup:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/images/as-root.png" alt="as root">
</div>
</div>
<div class="paragraph">
<p>By contrast a user with no role cannot perform these actions:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="images/images/as-baz.png" alt="as baz">
</div>
</div>
<div class="paragraph">
<p>To do that, we can access the <code>RoutingContext</code> user reference, and query for permissions.
Here is how this is implemented for the <code>indexHandler</code> handler method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private void indexHandler(RoutingContext context) {
  context.user().isAuthorized("create", res -&gt; {  <b class="conum">(1)</b>
    boolean canCreatePage = res.succeeded() &amp;&amp; res.result();  <b class="conum">(2)</b>
    dbService.fetchAllPages(reply -&gt; {
      if (reply.succeeded()) {
        context.put("title", "Wiki home");
        context.put("pages", reply.result().getList());
        context.put("canCreatePage", canCreatePage);  <b class="conum">(3)</b>
        context.put("username", context.user().principal().getString("username"));  <b class="conum">(4)</b>
        templateEngine.render(context, "templates", "/index.ftl", ar -&gt; {
          if (ar.succeeded()) {
            context.response().putHeader("Content-Type", "text/html");
            context.response().end(ar.result());
          } else {
            context.fail(ar.cause());
          }
        });
      } else {
        context.fail(reply.cause());
      }
    });
  });
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>This is how a permission query is made. Note that this is an asynchronous operation.</p>
</li>
<li>
<p>We use the result to&#8230;&#8203;</p>
</li>
<li>
<p>&#8230;&#8203;leverage it in the HTML template.</p>
</li>
<li>
<p>We also have access to the user login.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The template code has been modified to only render certain fragments based on the value of <code>canCreatePage</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-html" data-lang="html">&lt;#include "header.ftl"&gt;

&lt;div class="row"&gt;

  &lt;div class="col-md-12 mt-1"&gt;
  &lt;#if context.canCreatePage&gt;
    &lt;div class="float-xs-right"&gt;
      &lt;form class="form-inline" action="/action/create" method="post"&gt;
        &lt;div class="form-group"&gt;
          &lt;input type="text" class="form-control" id="name" name="name" placeholder="New page name"&gt;
        &lt;/div&gt;
        &lt;button type="submit" class="btn btn-primary"&gt;Create&lt;/button&gt;
      &lt;/form&gt;
    &lt;/div&gt;
  &lt;/#if&gt;
    &lt;h1 class="display-4"&gt;${context.title}&lt;/h1&gt;
    &lt;div class="float-xs-right"&gt;
      &lt;a class="btn btn-outline-danger" href="/logout" role="button" aria-pressed="true"&gt;Logout (${context.username})&lt;/a&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;div class="col-md-12 mt-1"&gt;
  &lt;#list context.pages&gt;
    &lt;h2&gt;Pages:&lt;/h2&gt;
    &lt;ul&gt;
      &lt;#items as page&gt;
        &lt;li&gt;&lt;a href="/wiki/${page}"&gt;${page}&lt;/a&gt;&lt;/li&gt;
      &lt;/#items&gt;
    &lt;/ul&gt;
  &lt;#else&gt;
    &lt;p&gt;The wiki is currently empty!&lt;/p&gt;
  &lt;/#list&gt;

  &lt;#if context.canCreatePage&gt;
    &lt;#if context.backup_gist_url?has_content&gt;
      &lt;div class="alert alert-success" role="alert"&gt;
        Successfully created a backup:
        &lt;a href="${context.backup_gist_url}" class="alert-link"&gt;${context.backup_gist_url}&lt;/a&gt;
      &lt;/div&gt;
    &lt;#else&gt;
      &lt;p&gt;
        &lt;a class="btn btn-outline-secondary btn-sm" href="/action/backup" role="button" aria-pressed="true"&gt;Backup&lt;/a&gt;
      &lt;/p&gt;
    &lt;/#if&gt;
  &lt;/#if&gt;
  &lt;/div&gt;

&lt;/div&gt;

&lt;#include "footer.ftl"&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The code is similar for ensuring that updating or deleting a page is restricted to certain roles and is available from the guide Git repository.</p>
</div>
<div class="paragraph">
<p>It is important to ensure that checks are also being done on HTTP POST request handlers and not just when rendering HTML pages.
Indeed, malicious attackers could still craft requests and perform actions while not being authenticated.
Here is how to protect page deletions by wrapping the <code>pageDeletionHandler</code> code inside a topmost permission check:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private void pageDeletionHandler(RoutingContext context) {
  context.user().isAuthorized("delete", res -&gt; {
    if (res.succeeded() &amp;&amp; res.result()) {

      // Original code:
      dbService.deletePage(Integer.valueOf(context.request().getParam("id")), reply -&gt; {
        if (reply.succeeded()) {
          context.response().setStatusCode(303);
          context.response().putHeader("Location", "/");
          context.response().end();
        } else {
          context.fail(reply.cause());
        }
      });

    } else {
      context.response().setStatusCode(403).end();
    }
  });
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_populating_the_database_with_user_and_role_data">Populating the database with user and role data</h3>
<div class="paragraph">
<p>A last step is required for assembling all pieces of our authentication puzzle.
We leave adding user registration and management as an exercice left to the reader, and instead we add some code to ensure that the database is being populated with some roles and accounts:</p>
</div>
<table class="tableblock frame-all grid-all spread">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Login</th>
<th class="tableblock halign-left valign-top">Password</th>
<th class="tableblock halign-left valign-top">Roles</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">root</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">admin</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">admin (create, delete, update)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">foo</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">bar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">editor (create, delete, update), writer (update)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">bar</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">baz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">writer (update)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">baz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">baz</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">/</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>vertx-auth-jdbc</code> prescribes a default database schema with 3 tables: 1 for users (with salted passwords), 1 for role permissions, and 1 to map users to roles.
That schema can be changed and configured, but in many cases sticking to the default is a very good option.</p>
</div>
<div class="paragraph">
<p>To do that, we are going to deploy a verticle whose sole role is performing the initialisation work:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">package io.vertx.guides.wiki.http;

import io.vertx.core.AbstractVerticle;
import io.vertx.core.AsyncResult;
import io.vertx.core.Handler;
import io.vertx.core.json.JsonObject;
import io.vertx.ext.jdbc.JDBCClient;
import io.vertx.ext.sql.ResultSet;
import io.vertx.ext.sql.SQLConnection;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.util.Arrays;
import java.util.List;

import static io.vertx.guides.wiki.DatabaseConstants.*;

public class AuthInitializerVerticle extends AbstractVerticle {

  private final Logger logger = LoggerFactory.getLogger(AuthInitializerVerticle.class);

  @Override
  public void start() throws Exception {

    List&lt;String&gt; schemaCreation = Arrays.asList(
      "create table if not exists user (username varchar(255), password varchar(255), password_salt varchar(255));",
      "create table if not exists user_roles (username varchar(255), role varchar(255));",
      "create table if not exists roles_perms (role varchar(255), perm varchar(255));"
    );

    /*
     * Passwords:
     *    root / admin
     *    foo / bar
     *    bar / baz
     *    baz / baz
     */
    List&lt;String&gt; dataInit = Arrays.asList( <b class="conum">(1)</b>
      "insert into user values ('root', 'C705F9EAD3406D0C17DDA3668A365D8991E6D1050C9A41329D9C67FC39E53437A39E83A9586E18C49AD10E41CBB71F0C06626741758E16F9B6C2BA4BEE74017E', '017DC3D7F89CD5E873B16E6CCE9A2307C8E3D9C5758741EEE49A899FFBC379D8');",
      "insert into user values ('foo', 'C3F0D72C1C3C8A11525B4563BAFF0E0F169114DE36796A595B78A373C522C0FF81BC2A683E2CB882A077847E8FD4DA09F1993072A4E9D7671313E4E5DB898F4E', '017DC3D7F89CD5E873B16E6CCE9A2307C8E3D9C5758741EEE49A899FFBC379D8');",
      "insert into user values ('bar', 'AEDD3E9FFCB847596A0596306A4303CC61C43D9904A0184951057D07D2FE2F36FA855C58EBCA9F3AEC9C65C46656F393E3D0F8711881F250D0D860F143A7A281', '017DC3D7F89CD5E873B16E6CCE9A2307C8E3D9C5758741EEE49A899FFBC379D8');",
      "insert into user values ('baz', 'AEDD3E9FFCB847596A0596306A4303CC61C43D9904A0184951057D07D2FE2F36FA855C58EBCA9F3AEC9C65C46656F393E3D0F8711881F250D0D860F143A7A281', '017DC3D7F89CD5E873B16E6CCE9A2307C8E3D9C5758741EEE49A899FFBC379D8');",
      "insert into roles_perms values ('editor', 'create');",
      "insert into roles_perms values ('editor', 'delete');",
      "insert into roles_perms values ('editor', 'update');",
      "insert into roles_perms values ('writer', 'update');",
      "insert into roles_perms values ('admin', 'create');",
      "insert into roles_perms values ('admin', 'delete');",
      "insert into roles_perms values ('admin', 'update');",
      "insert into user_roles values ('root', 'admin');",
      "insert into user_roles values ('foo', 'editor');",
      "insert into user_roles values ('foo', 'writer');",
      "insert into user_roles values ('bar', 'writer');"
    );

    JDBCClient dbClient = JDBCClient.createShared(vertx, new JsonObject()
      .put("url", config().getString(CONFIG_WIKIDB_JDBC_URL, DEFAULT_WIKIDB_JDBC_URL))
      .put("driver_class", config().getString(CONFIG_WIKIDB_JDBC_DRIVER_CLASS, DEFAULT_WIKIDB_JDBC_DRIVER_CLASS))
      .put("max_pool_size", config().getInteger(CONFIG_WIKIDB_JDBC_MAX_POOL_SIZE, DEFAULT_JDBC_MAX_POOL_SIZE)));


    dbClient.getConnection(car -&gt; {
      if (car.succeeded()) {
        SQLConnection connection = car.result();
        connection.batch(schemaCreation, ar -&gt; schemaCreationHandler(dataInit, connection, ar));
      } else {
        logger.error("Cannot obtain a database connection", car.cause());
      }
    });
  }

  private void schemaCreationHandler(List&lt;String&gt; dataInit, SQLConnection connection, AsyncResult&lt;List&lt;Integer&gt;&gt; ar) {
    if (ar.succeeded()) {
      connection.query("select count(*) from user;", testQueryHandler(dataInit, connection));
    } else {
      connection.close();
      logger.error("Schema creation failed", ar.cause());
    }
  }

  private Handler&lt;AsyncResult&lt;ResultSet&gt;&gt; testQueryHandler(List&lt;String&gt; dataInit, SQLConnection connection) {
    return ar -&gt; {
      if (ar.succeeded()) {
        if (ar.result().getResults().get(0).getInteger(0) == 0) {
          logger.info("Need to insert data");
          connection.batch(dataInit, batchInsertHandler(connection));
        } else {
          logger.info("No need to insert data");
          connection.close();
        }
      } else {
        connection.close();
        logger.error("Could not check the number of users in the database", ar.cause());
      }
    };
  }

  private Handler&lt;AsyncResult&lt;List&lt;Integer&gt;&gt;&gt; batchInsertHandler(SQLConnection connection) {
    return ar -&gt; {
      if (ar.succeeded()) {
        logger.info("Successfully inserted data");
      } else {
        logger.error("Could not insert data", ar.cause());
      }
      connection.close();
    };
  }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>The hashed values can be generated using <code>auth.computeHash(password, salt)</code> where <code>auth</code> is a <code>JDBCAuth</code> instance.
Salt values can also be generated using <code>auth.generateSalt()</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>This impacts the <code>MainVerticle</code> class, as we now deploy it first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public class MainVerticle extends AbstractVerticle {

  @Override
  public void start(Future&lt;Void&gt; startFuture) throws Exception {

    Future&lt;String&gt; dbVerticleDeployment = Future.future();
    vertx.deployVerticle(new WikiDatabaseVerticle(), dbVerticleDeployment);

    dbVerticleDeployment.compose(id -&gt; {
      Future&lt;String&gt; authInitDeployment = Future.future();
      vertx.deployVerticle(new AuthInitializerVerticle(), authInitDeployment);
      return authInitDeployment;
    }).compose(id -&gt; {
      Future&lt;String&gt; httpVerticleDeployment = Future.future();
      vertx.deployVerticle(
        "io.vertx.guides.wiki.http.HttpServerVerticle",
        new DeploymentOptions().setInstances(2),
        httpVerticleDeployment.completer());
      return httpVerticleDeployment;
    }).setHandler(ar -&gt; {
      if (ar.succeeded()) {
        startFuture.complete();
      } else {
        startFuture.fail(ar.cause());
      }
    });
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we also need to update the <code>ApiTest</code> class to setup the in-memory database for both the authentication and wiki storage:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">JsonObject dbConf = new JsonObject()
  .put(WikiDatabaseVerticle.CONFIG_WIKIDB_JDBC_URL, "jdbc:hsqldb:mem:testdb;shutdown=true")
  .put(WikiDatabaseVerticle.CONFIG_WIKIDB_JDBC_MAX_POOL_SIZE, 4);

vertx.deployVerticle(new AuthInitializerVerticle(),
  new DeploymentOptions().setConfig(dbConf), context.asyncAssertSuccess());

vertx.deployVerticle(new WikiDatabaseVerticle(),
  new DeploymentOptions().setConfig(dbConf), context.asyncAssertSuccess());</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authenticating_web_api_requests_with_jwt">Authenticating web API requests with JWT</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a href="https://jwt.io/">JSON Web Tokens</a> (<a href="https://tools.ietf.org/html/rfc7519">RFC 7519</a>) is a standard for issuing JSON-encoded tokens containing <em>claims</em>, typically identifying a user and permissions, although claims can be just about anything.</p>
</div>
<div class="paragraph">
<p>A token is issued by a server and it is signed with the server key.
A client can send a token back along with subsequent requests: both the client and the server can check that a token is authentic and unaltered.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<div class="title">Warning</div>
</td>
<td class="content">
While a JWT token is signed, its content is not encrypted. It must be transported over a secure channel (e.g., HTTPS) and it should never have sensitive data as a claim (e.g., passwords, private API keys, etc).
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_adding_jwt_support">Adding JWT support</h3>
<div class="paragraph">
<p>We start by adding the <code>vertx-auth-jwt</code> module to the Maven dependencies:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
  &lt;groupId&gt;io.vertx&lt;/groupId&gt;
  &lt;artifactId&gt;vertx-auth-jwt&lt;/artifactId&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We will have a JCEKS keystore to hold the keys for our tests.
Here is how to generate a <code>keystore.jceks</code> with the suitable keys of various lengths:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">keytool -genseckey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg HMacSHA256 -keysize 2048 -alias HS256 -keypass secret
keytool -genseckey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg HMacSHA384 -keysize 2048 -alias HS384 -keypass secret
keytool -genseckey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg HMacSHA512 -keysize 2048 -alias HS512 -keypass secret
keytool -genkey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg RSA -keysize 2048 -alias RS256 -keypass secret -sigalg SHA256withRSA -dname "CN=,OU=,O=,L=,ST=,C=" -validity 360
keytool -genkey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg RSA -keysize 2048 -alias RS384 -keypass secret -sigalg SHA384withRSA -dname "CN=,OU=,O=,L=,ST=,C=" -validity 360
keytool -genkey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg RSA -keysize 2048 -alias RS512 -keypass secret -sigalg SHA512withRSA -dname "CN=,OU=,O=,L=,ST=,C=" -validity 360
keytool -genkeypair -keystore keystore.jceks -storetype jceks -storepass secret -keyalg EC -keysize 256 -alias ES256 -keypass secret -sigalg SHA256withECDSA -dname "CN=,OU=,O=,L=,ST=,C=" -validity 360
keytool -genkeypair -keystore keystore.jceks -storetype jceks -storepass secret -keyalg EC -keysize 256 -alias ES384 -keypass secret -sigalg SHA384withECDSA -dname "CN=,OU=,O=,L=,ST=,C=" -validity 360
keytool -genkeypair -keystore keystore.jceks -storetype jceks -storepass secret -keyalg EC -keysize 256 -alias ES512 -keypass secret -sigalg SHA512withECDSA -dname "CN=,OU=,O=,L=,ST=,C=" -validity 360</code></pre>
</div>
</div>
<div class="paragraph">
<p>We need to install a JWT token handler on API routes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Router apiRouter = Router.router(vertx);

JWTAuth jwtAuth = JWTAuth.create(vertx, new JWTAuthOptions()
  .setKeyStore(new KeyStoreOptions()
    .setPath("keystore.jceks")
    .setType("jceks")
    .setPassword("secret")));

apiRouter.route().handler(JWTAuthHandler.create(jwtAuth, "/api/token"));</code></pre>
</div>
</div>
<div class="paragraph">
<p>We pass <code>/api/token</code> as a parameter for the <code>JWTAuthHandler</code> object creation to specify that this URL shall be ignored.
Indeed, this URL is being used to generate new JWT tokens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">apiRouter.get("/token").handler(context -&gt; {

  JsonObject creds = new JsonObject()
    .put("username", context.request().getHeader("login"))
    .put("password", context.request().getHeader("password"));
  auth.authenticate(creds, authResult -&gt; {  <b class="conum">(1)</b>

    if (authResult.succeeded()) {
      User user = authResult.result();
      user.isAuthorized("create", canCreate -&gt; {  <b class="conum">(2)</b>
        user.isAuthorized("delete", canDelete -&gt; {
          user.isAuthorized("update", canUpdate -&gt; {

            String token = jwtAuth.generateToken( <b class="conum">(3)</b>
              new JsonObject()
                .put("username", context.request().getHeader("login"))
                .put("canCreate", canCreate.succeeded() &amp;&amp; canCreate.result())
                .put("canDelete", canDelete.succeeded() &amp;&amp; canDelete.result())
                .put("canUpdate", canUpdate.succeeded() &amp;&amp; canUpdate.result()),
              new JWTOptions()
                .setSubject("Wiki API")
                .setIssuer("Vert.x"));
            context.response().putHeader("Content-Type", "text/plain").end(token);
          });
        });
      });
    } else {
      context.fail(401);
    }
  });
});</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We expect login and password information to have been passed through HTTP request headers, and we authenticate using the authentication provider of the previous section.</p>
</li>
<li>
<p>Upon success we can query for roles.</p>
</li>
<li>
<p>We generate a token with <code>username</code>, <code>canCreate</code>, <code>canDelete</code> and <code>canUpdate</code> claims.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Each API handler method can now query the current user principal and claims.
Here is how the <code>apiDeletePage</code> does it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private void apiDeletePage(RoutingContext context) {
  if (context.user().principal().getBoolean("canDelete", false)) {
    int id = Integer.valueOf(context.request().getParam("id"));
    dbService.deletePage(id, reply -&gt; {
      handleSimpleDbReply(context, reply);
    });
  } else {
    context.fail(401);
  }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_jwt_tokens">Using JWT tokens</h3>
<div class="paragraph">
<p>To illustrate how to work with JWT tokens, let&#8217;s create a new one for the <code>root</code> user:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ http --verbose --verify no GET https://localhost:8080/api/token login:root password:w00t
GET /api/token HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate
Connection: keep-alive
Host: localhost:8080
User-Agent: HTTPie/0.9.8
login: root
password: w00t



HTTP/1.1 200 OK
Content-Length: 242
Content-Type: text/plain
Set-Cookie: vertx-web.session=8cbb38ac4ce96737bfe31cc0ceaae2b9; Path=/

eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6InJvb3QiLCJjYW5DcmVhdGUiOnRydWUsImNhbkRlbGV0ZSI6dHJ1ZSwiY2FuVXBkYXRlIjp0cnVlLCJpYXQiOjE0ODk0NDE1OTAsImlzcyI6IlZlcnQueCIsInN1YiI6Ildpa2kgQVBJIn0=.RmtJb81QKVUFreXL-ajZ8ktLGasoKEqG8GSQncRWrN8=</pre>
</div>
</div>
<div class="paragraph">
<p>The response text is the token value and shall be retained.</p>
</div>
<div class="paragraph">
<p>We can check that performing an API request without the token results in a denial of access:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ http --verbose --verify no GET https://localhost:8080/api/pages
GET /api/pages HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate
Connection: keep-alive
Host: localhost:8080
User-Agent: HTTPie/0.9.8



HTTP/1.1 401 Unauthorized
Content-Length: 12

Unauthorized</pre>
</div>
</div>
<div class="paragraph">
<p>Sending a JWT token along with a request is done using a <code>Authorization</code> HTTP request header where the value must be <code>Bearer &lt;token value&gt;</code>.
Here is how to fix the API request above by passing the JWT token that had been issued to us:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>$ http --verbose --verify no GET https://localhost:8080/api/pages Authorization:'Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6InJvb3QiLCJjYW5DcmVhdGUiOnRydWUsImNhbkRlbGV0ZSI6dHJ1ZSwiY2FuVXBkYXRlIjp0cnVlLCJpYXQiOjE0ODk0NDE1OTAsImlzcyI6IlZlcnQueCIsInN1YiI6Ildpa2kgQVBJIn0=.RmtJb81QKVUFreXL-ajZ8ktLGasoKEqG8GSQncRWrN8='
GET /api/pages HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate
Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VybmFtZSI6InJvb3QiLCJjYW5DcmVhdGUiOnRydWUsImNhbkRlbGV0ZSI6dHJ1ZSwiY2FuVXBkYXRlIjp0cnVlLCJpYXQiOjE0ODk0NDE1OTAsImlzcyI6IlZlcnQueCIsInN1YiI6Ildpa2kgQVBJIn0=.RmtJb81QKVUFreXL-ajZ8ktLGasoKEqG8GSQncRWrN8=
Connection: keep-alive
Host: localhost:8080
User-Agent: HTTPie/0.9.8



HTTP/1.1 200 OK
Content-Length: 99
Content-Type: application/json
Set-Cookie: vertx-web.session=0598697483371c7f3cb434fbe35f15e4; Path=/

{
    "pages": [
        {
            "id": 0,
            "name": "Hello"
        },
        {
            "id": 1,
            "name": "Apple"
        },
        {
            "id": 2,
            "name": "Vert.x"
        }
    ],
    "success": true
}</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_adapting_the_api_test_fixture">Adapting the API test fixture</h3>
<div class="paragraph">
<p>The <code>ApiTest</code> class needs to be updated to support JWT tokens.</p>
</div>
<div class="paragraph">
<p>We add a new field for retrieving the token value to be used in test cases:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">private String jwtTokenHeaderValue;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We add first step to retrieve a JTW token authenticated as user <code>foo</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">@Test
public void play_with_api(TestContext context) {
  Async async = context.async();

  Future&lt;String&gt; tokenRequest = Future.future();
  webClient.get("/api/token")
    .putHeader("login", "foo")  <b class="conum">(1)</b>
    .putHeader("password", "bar")
    .as(BodyCodec.string()) <b class="conum">(2)</b>
    .send(ar -&gt; {
      if (ar.succeeded()) {
        tokenRequest.complete(ar.result().body());  <b class="conum">(3)</b>
      } else {
        context.fail(ar.cause());
      }
    });
  // (...)</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Credentials are passed as headers.</p>
</li>
<li>
<p>The response payload is of <code>text/plain</code> type, so we use that for the body decoding codec.</p>
</li>
<li>
<p>Upon success we complete the <code>tokenRequest</code> future with the token value.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Using the JWT token is now a matter of passing it back as a header to HTTP requests:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Future&lt;JsonObject&gt; postRequest = Future.future();
tokenRequest.compose(token -&gt; {
  jwtTokenHeaderValue = "Bearer " + token;  <b class="conum">(1)</b>
  webClient.post("/api/pages")
    .putHeader("Authorization", jwtTokenHeaderValue)  <b class="conum">(2)</b>
    .as(BodyCodec.jsonObject())
    .sendJsonObject(page, ar -&gt; {
      if (ar.succeeded()) {
        HttpResponse&lt;JsonObject&gt; postResponse = ar.result();
        postRequest.complete(postResponse.body());
      } else {
        context.fail(ar.cause());
      }
    });
}, postRequest);

Future&lt;JsonObject&gt; getRequest = Future.future();
postRequest.compose(h -&gt; {
  webClient.get("/api/pages")
    .putHeader("Authorization", jwtTokenHeaderValue)
    .as(BodyCodec.jsonObject())
    .send(ar -&gt; {
      if (ar.succeeded()) {
        HttpResponse&lt;JsonObject&gt; getResponse = ar.result();
        getRequest.complete(getResponse.body());
      } else {
        context.fail(ar.cause());
      }
    });
}, getRequest);
// (...)</code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We store the token with the <code>Bearer</code> prefix to the field for the next requests.</p>
</li>
<li>
<p>We pass the token as a header.</p>
</li>
</ol>
</div>
</div>
</div>
</div>
        

        
          <div id="footer">
            <div id="footer-text">
              
                上次更新时间 2018-06-05 07:44:38 CST
              
              
            </div>
          </div>
        
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse Vert.x</h2>
        <ul class="list-unstyled">
          <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//">主页</a></li>
          <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//download/">下载</a></li>
          <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//docs/">文档</a></li>
          <li><a href="https://github.com/vert-x3/wiki/wiki">维基</a></li>
          <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//blog/">博客</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Community</h2>
        <ul class="list-unstyled">
          <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//community/">帮助 &amp; 贡献者</a></li>
          <li><a href="https://okou19900722.gitee.io/cn.vertx.tk//materials/">学习资料</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx">User Group</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx-dev">Developer Group</a></li>
          <li><a href="//shang.qq.com/wpa/qunwpa?idkey=587f58cacb9557e3291b46098e0fe09427b98a1c0f866da23c04c2762bc7e2ad">QQ群</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse</h2>
        <ul class="list-unstyled">
          <li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li>
          <li><a href="https://eclipse.org/legal/privacy.php">Privacy Policy</a></li>
          <li><a href="https://eclipse.org/legal/termsofuse.php">Terms of Use</a></li>
          <li><a href="https://eclipse.org/legal/copyright.php">Copyright Agent</a></li>
          <li><a href="http://www.eclipse.org/legal">Legal Resources</a></li>
        </ul>
      </div>

      <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright">
        <p>Eclipse Vert.x is open source and dual-licensed under the <a href="http://www.eclipse.org/legal/epl-v20.html">Eclipse Public License 2.0</a> and <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License 2.0</a>.</p>
        <p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>
        Design by <a href="https://www.michel-kraemer.com">Michel Kr&auml;mer</a>.</p>
        <div class="row">
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2">
            <a href="http://eclipse.org">
            <img class="logo eclipse-logo" src="https://okou19900722.gitee.io/cn.vertx.tk//assets/eclipse_logo_grey_small.png" width="204" height="48">
            </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0">
            <a href="http://cloudbees.com">
            <img class="logo cloudbees-logo" src="https://okou19900722.gitee.io/cn.vertx.tk//assets/Button-Built-on-CB-1-grey.png" width="180" height="48">
           </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler">
            <a href="http://www.ej-technologies.com/products/jprofiler/overview.html"
            style="text-decoration:none">
            <img class="logo jprofiler-logo" src="https://okou19900722.gitee.io/cn.vertx.tk//assets/jprofiler-logo.png" width="48" height="48"><span class="jprofiler-logo">&nbsp; JPROFILER</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://okou19900722.gitee.io/cn.vertx.tk//javascripts/bootstrap.min.js"></script>
<script src="https://okou19900722.gitee.io/cn.vertx.tk//javascripts/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script src="https://okou19900722.gitee.io/cn.vertx.tk//javascripts/sidebar.js"></script>


<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});
</script>
</body>
</html>

