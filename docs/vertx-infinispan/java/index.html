<!DOCTYPE html>
<html lang="en">
<head>
  <title>Infinispan Cluster Manager - Vert.x</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name="description">
  <link href="https://vertx.tk/stylesheets/docs.css" media="screen" rel="stylesheet">
  <link href="https://vertx.tk/stylesheets/font-awesome.min.css" media="screen" rel="stylesheet">
  <link href="https://vertx.tk/javascripts/styles/rainbow.min.css" media="screen" rel="stylesheet">
  <!-- IE 6-8 support of HTML 5 elements -->
  <!--[if lt IE 9]>
  <script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script>
  <![endif]-->

  <link rel="apple-touch-icon" sizes="57x57" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="https://vertx.tk/assets/favicons/vertx-favicon-7/manifest.json">
  <link rel="mask-icon" href="https://vertx.tk/assets/favicons/vertx-favicon-7/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#7d3194">
  <meta name="msapplication-TileImage" content="https://vertx.tk/assets/favicons/vertx-favicon-7/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel="stylesheet" type="text/css">
  <link rel="alternate" type="application/rss+xml" title="RSS"
     href="https://vertx.tk/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');
  </script>
  <style>
    .page-link-to-github {
      position: relative;
      z-index: 1;
      display: inline-block;
      border: 1px solid #782B90;
      border-radius: 5px;
      color: #782B90;
      font-size: 12px;
      padding: 4px 10px;
      text-decoration: none;
      background-color: #ffffff;
    }
    .page-link-to-github:hover {
      color: #ffffff;
      border-color: #ffffff;
      background-color: #782B90;
    }

    .page-link-to-github .github-icon {
      position: absolute;
      display: inline-block;
      width: 20px;
      height: 20px;
      /*background-position: -50px 0*/
      background: url('https://vertx.tk/assets/github.png') no-repeat 0 0;
    }

    @media (-webkit-min-device-pixel-ratio: 2),(min-resolution:192dpi) {
      .page-link-to-github .github-icon {
        background-image:url('https://vertx.tk/assets/github@2x.png');
        background-size: 150px auto
      }
    }

    .page-link-to-github:hover .github-icon {
      /*background-position: 0 0*/
      background-position: -100px 0
    }
    .text {
      text-decoration: underline
    }
    .page-link-to-github .text {
      padding-left: 27px
    }
    .text {
      padding-right: 8px
    }
    .page-link-to-github {
      float: right;
      top: 4px
    }

  </style>
</head>
<body>

<a href="http://www.reactivemanifesto.org/" id="reactive-manifesto-banner">
  <img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000"
    src="https://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png">
</a>

<a id="skippy" class="sr-only sr-only-focusable" href="#content"><div class="container"><span class="skiplink-text">Skip to main content</span></div></a>

<header class="navbar navbar-default navbar-static-top" id="top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#vertx-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="https://vertx.tk/" class="navbar-brand"><img alt="Brand" src="https://vertx.tk/assets/logo-sm.png"></a>
    </div>
    <nav class="collapse navbar-collapse" id="vertx-navbar-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://start.vertx.io">Starter</a></li>
        <li><a href="https://vertx.tk/download/">下载</a></li>
        <li><a href="https://vertx.tk/docs/">文档</a></li>
        <li><a href="https://github.com/vert-x3/wiki/wiki">维基</a></li>
        <li><a href="https://vertx.tk/community/">社区</a></li>
        <li><a href="https://vertx.tk/materials/">资料</a></li>
        <li><a href="https://vertx.tk/blog/">博客</a></li>
      </ul>
    </nav>
  </div>
</header>



  <div class="page-header" id="content">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1>Infinispan Cluster Manager</h1>
          
        </div>
      </div>
    </div>
  </div>




<div id="content">
  <div class="container docs-content">
    <div class="row">
      <div class="col-sm-12 col-md-push-9 col-md-3 hidden-xs hidden-sm">
        <div id="sidebar" data-spy="affix">
          <ul class="sectlevel1">
<li><a href="#_使用_infinispan_cluster_manager">使用 Infinispan cluster manager</a></li>
<li><a href="#_配置_infinispan_cluster_manager">配置 Infinispan cluster manager</a></li>
<li><a href="#_使用已有_infinispan_cache_manager">使用已有 Infinispan Cache Manager</a></li>
<li><a href="#_configuring_for_kubernetes">Configuring for Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_rolling_updates">Rolling updates</a></li>
</ul>
</li>
<li><a href="#_适配_docker_compose">适配 Docker Compose</a></li>
<li><a href="#_故障排除">故障排除</a>
<ul class="sectlevel2">
<li><a href="#_组播未正常开启">组播未正常开启</a></li>
<li><a href="#_使用错误的网络接口">使用错误的网络接口</a></li>
<li><a href="#_使用vpn">使用VPN</a></li>
<li><a href="#_组播被禁用">组播被禁用</a></li>
<li><a href="#_ipv6_错误">IPv6 错误</a></li>
<li><a href="#_infinispan_日志配置">Infinispan 日志配置</a></li>
</ul>
</li>
<li><a href="#_infinispan_logging">Infinispan logging</a></li>
<li><a href="#_jgroups_日志配置">JGroups 日志配置</a></li>
<li><a href="#_shareddata_extensions">SharedData extensions</a>
<ul class="sectlevel2">
<li><a href="#_asyncmap_content_streams">AsyncMap content streams</a></li>
</ul>
</li>
</ul>
        </div>
      </div>
      <div class="col-sm-12 col-md-pull-3 col-md-9">
        <div class="toc hidden-md hidden-lg">
          <h2>Table of Contents</h2>
          <ul class="sectlevel1">
<li><a href="#_使用_infinispan_cluster_manager">使用 Infinispan cluster manager</a></li>
<li><a href="#_配置_infinispan_cluster_manager">配置 Infinispan cluster manager</a></li>
<li><a href="#_使用已有_infinispan_cache_manager">使用已有 Infinispan Cache Manager</a></li>
<li><a href="#_configuring_for_kubernetes">Configuring for Kubernetes</a>
<ul class="sectlevel2">
<li><a href="#_rolling_updates">Rolling updates</a></li>
</ul>
</li>
<li><a href="#_适配_docker_compose">适配 Docker Compose</a></li>
<li><a href="#_故障排除">故障排除</a>
<ul class="sectlevel2">
<li><a href="#_组播未正常开启">组播未正常开启</a></li>
<li><a href="#_使用错误的网络接口">使用错误的网络接口</a></li>
<li><a href="#_使用vpn">使用VPN</a></li>
<li><a href="#_组播被禁用">组播被禁用</a></li>
<li><a href="#_ipv6_错误">IPv6 错误</a></li>
<li><a href="#_infinispan_日志配置">Infinispan 日志配置</a></li>
</ul>
</li>
<li><a href="#_infinispan_logging">Infinispan logging</a></li>
<li><a href="#_jgroups_日志配置">JGroups 日志配置</a></li>
<li><a href="#_shareddata_extensions">SharedData extensions</a>
<ul class="sectlevel2">
<li><a href="#_asyncmap_content_streams">AsyncMap content streams</a></li>
</ul>
</li>
</ul>
        </div>

  <a href="https://github.com/okou19900722/vertx-web-site-translation-chinese/tree/master/vertx-translation-stack/vertx-infinispan-translation"
     class="page-link-to-github"
     target="_blank"
     title="Edit this page on GitHub">
    <i class="github-icon"></i>
    <span class="text">编辑本页</span>
  </a>

        <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><code>InfinispanClusterManager</code> 是基于 <a href="http://infinispan.org/">Infinispan</a> 实现。</p>
</div>
<div class="paragraph">
<p>This implementation is packaged inside:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maven (在 <code>pom.xml</code> 文件中):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;io.vertx&lt;/groupId&gt;
 &lt;artifactId&gt;vertx-infinispan&lt;/artifactId&gt;
 &lt;version&gt;3.6.0-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Gradle (在 <code>build.gradle</code> 文件中):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">compile 'io.vertx:vertx-infinispan:3.6.0-SNAPSHOT'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Vert.x 集群管理器包含以下几个功能：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>发现并管理集群中的节点</p>
</li>
<li>
<p>管理集群端的主题订阅清单（这样就可以轻松得知集群中的那些节点订阅了那些 EventBus 地址）</p>
</li>
<li>
<p>分布式 Map 支持</p>
</li>
<li>
<p>分布式锁</p>
</li>
<li>
<p>分布式计数器</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Vert.x 集群器并不处理节点之间的通信，在 Vert.x 中节点中的通信是直接由 TCP 链接处理的。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_使用_infinispan_cluster_manager">使用 Infinispan cluster manager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vert.x 能够从 classpath 路径的 jar 自动检测并使用出 <code>ClusterManager</code> 的实现。不过需要确保在 classpath 没有其他的 <code>ClusterManager</code> 实现。</p>
</div>
<div class="paragraph">
<p>If you want clustering with this cluster manager in your Vert.x Maven or Gradle project then just add a dependency to
the artifact: <code>io.vertx:vertx-infinispan:3.6.0-SNAPSHOT</code> in your project.</p>
</div>
<div class="paragraph">
<p>If the jar is on your classpath as above then Vert.x will automatically detect this and use it as the cluster manager.
Please make sure you don&#8217;t have any other cluster managers on your classpath or Vert.x might
choose the wrong one.</p>
</div>
<div class="paragraph">
<p>You can also specify the cluster manager programmatically if you are embedding Vert.x by specifying it on the options
when you are creating your Vert.x instance, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ClusterManager mgr = new InfinispanClusterManager();

VertxOptions options = new VertxOptions().setClusterManager(mgr);

Vertx.clusteredVertx(options, res -&gt; {
  if (res.succeeded()) {
    Vertx vertx = res.result();
  } else {
    // failed!
  }
});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_配置_infinispan_cluster_manager">配置 Infinispan cluster manager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The default cluster manager configuration can be modified with <code>infinispan.xml</code> and/or <code>jgroups.xml</code> files.
The former configures the data grid, the latter group management and member discovery.</p>
</div>
<div class="paragraph">
<p>如果要覆盖其中任意一个配置文件，可以在 <code>classpath</code> 中添加对应的文件。
如果想在 fat jar 中内嵌相应的配置文件 ，此文件必须在 fat jar 的根目录中。
如果此文件是一个外部文件，则必须将其添加至 <code>classpath</code> 中。举个例子：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">#  infinispan.xml 和/或 jgroups.xml 在当前路径中
java -jar my-app.jar -cp . -cluster

# infinispan.xml 和/或 jgroups.xml 在 conf 目录中
java -jar my-app.jar -cp conf -cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>还有一种方式来覆盖默认的配置文件，那就是利用系统配置 <code>vertx.infinispan.config</code> 和/或 <code>vertx.jgroups.config</code> 来实现：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell"># 指定一个外部文件为自定义配置文件
java -Dvertx.infinispan.config=./config/my-infinispan.xml -jar ... -cluster

# 从 classpath 中加载一个文件为自定义配置文件
java -Dvertx.infinispan.config=my/package/config/my-infinispan.xml -jar ... -cluster</code></pre>
</div>
</div>
<div class="paragraph">
<p>The cluster manager will search for the file in classpath first, and fallback to the filesystem.</p>
</div>
<div class="paragraph">
<p>The system properties, when present, override any <code>infinispan.xml</code> or <code>jgroups.xml</code> on the classpath.</p>
</div>
<div class="paragraph">
<p>The xml files are Infinispan and JGroups configuration files and are described in detail in the documentation on the Infinispan and JGroups web-sites.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<div class="title">Important</div>
</td>
<td class="content">
if a <code>jgroups.xml</code> file is on the classpath or if you set the <code>vertx.jgroups.config</code> system property,
it will override any JGroups <code>stack-file</code> path defined in the Infinispan configuration file.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The default JGroups configuration uses multicast for discovery and TCP for group management.
Make sure multicast is enabled on your network for this to work.</p>
</div>
<div class="paragraph">
<p>For full documentation on how to configure the transport differently or use a different transport please consult the
Infinispan / JGroups documentations.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_使用已有_infinispan_cache_manager">使用已有 Infinispan Cache Manager</h2>
<div class="sectionbody">
<div class="paragraph">
<p>开发者可以通过 <code>DefaultCacheManager</code> 来复用已经存在的 <code>cache manager</code>。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">ClusterManager mgr = new InfinispanClusterManager(cacheManager);

VertxOptions options = new VertxOptions().setClusterManager(mgr);

Vertx.clusteredVertx(options, res -&gt; {
  if (res.succeeded()) {
    Vertx vertx = res.result();
  } else {
    // failed!
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>在这种情况下，Vert.x 并不是 <code>cache manager</code> 的所有者，因此不能在关闭 Vert.x 时，停止 Infinispan 。</p>
</div>
<div class="paragraph">
<p>需要注意的是，需要通过如下配置来自定义 Infinispan 实例：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;cache-container default-cache="distributed-cache"&gt;
 &lt;distributed-cache name="distributed-cache"/&gt;
 &lt;distributed-cache name="__vertx.subs"/&gt;
 &lt;replicated-cache name="__vertx.haInfo"/&gt;
 &lt;distributed-cache-configuration name="__vertx.distributed.cache.configuration"/&gt;
&lt;/cache-container&gt;</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuring_for_kubernetes">Configuring for Kubernetes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>On Kubernetes, JGroups should be configured to use the <code>KUBE_PING</code> protocol.</p>
</div>
<div class="paragraph">
<p>First, add the <code>org.infinispan:infinispan-cloud:${infinispan.version}</code> and <code>org.jgroups.kubernetes:jgroups-kubernetes:${jgroups.kubernetes.version}</code> dependencies to your project.
With Maven it looks like:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;org.infinispan&lt;/groupId&gt;
 &lt;artifactId&gt;infinispan-cloud&lt;/artifactId&gt;
 &lt;version&gt;${infinispan.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
 &lt;groupId&gt;org.jgroups.kubernetes&lt;/groupId&gt;
 &lt;artifactId&gt;jgroups-kubernetes&lt;/artifactId&gt;
 &lt;version&gt;${jgroups.kubernetes.version}&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, set the <code>vertx.jgroups.config</code> system property to <code>default-configs/default-jgroups-kubernetes.xml</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">-Dvertx.jgroups.config=default-configs/default-jgroups-kubernetes.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>This JGroups stack file is located in the <code>infinispan-cloud</code> JAR and preconfigured for Kubernetes.</p>
</div>
<div class="paragraph">
<p>Also, set the project namespace as the scope for discovery.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-Dockerfile" data-lang="Dockerfile">ENV KUBERNETES_NAMESPACE my-project</code></pre>
</div>
</div>
<div class="paragraph">
<p>Optionnaly, to create separate clusters in the same namespace, add a labels selector:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-Dockerfile" data-lang="Dockerfile">ENV KUBERNETES_LABELS my-label=my-value</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, force usage of IPv4 in the JVM with a system property.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">-Djava.net.preferIPv4Stack=true</code></pre>
</div>
</div>
<div class="paragraph">
<p>Eventually, the setup needs a service account.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">oc policy add-role-to-user view system:serviceaccount:$(oc project -q):default -n $(oc project -q)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Further configuration details are available on the <a href="https://github.com/jgroups-extras/jgroups-kubernetes">Kubernetes discovery protocol for JGroups repository</a>.</p>
</div>
<div class="sect2">
<h3 id="_rolling_updates">Rolling updates</h3>
<div class="paragraph">
<p>During rolling udpates, the Infinispan team <a href="http://infinispan.org/docs/stable/user_guide/user_guide.html#using_kubernetes_and_openshift_rolling_updates">recommends</a> to replace pods one by one.</p>
</div>
<div class="paragraph">
<p>To do so, we must configure Kubernetes to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>never start more than one new pod at once</p>
</li>
<li>
<p>forbid more than one unavailable pod during the process</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">spec:
 strategy:
   type: Rolling
   rollingParams:
     updatePeriodSeconds: 10
     intervalSeconds: 20
     timeoutSeconds: 600
     maxUnavailable: 1 <b class="conum">(1)</b>
     maxSurge: 1 <b class="conum">(2)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>the maximum number of pods that can be unavailable during the update process</p>
</li>
<li>
<p>the maximum number of pods that can be created over the desired number of pods</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Also, pod readiness probe must take cluster health into account.
Indeed, when a node joins or leaves the cluster, Infinispan rebalances the data across members, and it is better to avoid concurrent state transfers.
When the state transfer completes, the cluster health goes back to <code>HEALTHY</code>.</p>
</div>
<div class="paragraph">
<p>The readiness probe can be implemented with <a href="../../vertx-health-check/java/">Vert.x Health Checks</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Handler&lt;Future&lt;Status&gt;&gt; procedure = ClusterHealthCheck.createProcedure(vertx, true);
HealthChecks checks = HealthChecks.create(vertx).register("cluster-health", procedure);</code></pre>
</div>
</div>
<div class="paragraph">
<p>After creation, it can be exposed over HTTP with a <a href="../../vertx-web/java/">Vert.x Web</a> router handler:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Router router = Router.router(vertx);
router.get("/readiness").handler(HealthCheckHandler.createWithHealthChecks(checks));</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_适配_docker_compose">适配 Docker Compose</h2>
<div class="sectionbody">
<div class="paragraph">
<p>确认 JVM 在启动时 设置了下面两项配置：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-shell" data-lang="shell">-Djava.net.preferIPv4Stack=true -Djgroups.tcp.address=NON_LOOPBACK</code></pre>
</div>
</div>
<div class="paragraph">
<p>通过上述两项系统配置，JGroups 才能正确的挑选出 Docker 创建的虚拟网络接口。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_故障排除">故障排除</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If the default multicast discovery configuration is not working here are some common causes:</p>
</div>
<div class="sect2">
<h3 id="_组播未正常开启">组播未正常开启</h3>
<div class="paragraph">
<p>MacOS 默认禁用组播。Google一下启用组播。</p>
</div>
</div>
<div class="sect2">
<h3 id="_使用错误的网络接口">使用错误的网络接口</h3>
<div class="paragraph">
<p>如果机器上有多个网络接口（也有可能是在运行 VPN 的情况下），那么 JGroups 很有可能是使用了错误的网络接口。</p>
</div>
<div class="paragraph">
<p>为了确保 JGroups 使用正确的网络接口，在配置文件中将 <code>bind_addr</code> 设置为指定IP地址。 例如：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;TCP bind_addr="192.168.1.20"
    ...
    /&gt;
&lt;MPING bind_addr="192.168.1.20"
    ...
    /&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>另外，如果需要修改打包好的 <code>jgoups.xml</code> 文件，可以通过设置 <code>jgroups.tcp.address</code> 系统变量来达到目的</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-Djgroups.tcp.address=192.168.1.20</pre>
</div>
</div>
<div class="paragraph">
<p>当运行集群模式时，需要确保 Vert.x 使用正确的网络接口。
当通过命令行模式时，可以设置 <code>cluster-host</code> 参数：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>vertx run myverticle.js -cluster -cluster-host your-ip-address</pre>
</div>
</div>
<div class="paragraph">
<p>其中 <code>your-ip-address</code> 必须与 JGroup 中的配置保持一致。</p>
</div>
<div class="paragraph">
<p>当通过编程模式使用 Vert.x 时，可以调用方法
`<a href="../../apidocs/io/vertx/core/VertxOptions.html#setClusterHost-java.lang.String-">setClusterHost</a>`来设置参数</p>
</div>
</div>
<div class="sect2">
<h3 id="_使用vpn">使用VPN</h3>
<div class="paragraph">
<p>VPN软件通常通过创建不支持多播虚拟网络接口来进行工作。如果有一个 VPN 运行，如果 JGroups与 Vert.x 不正确配置的话，VPN接口将被选择，而不是正确的接口。</p>
</div>
<div class="paragraph">
<p>所以，如果你运行在 VPN 环境中，参考上述章节，设置正确的网络接口。</p>
</div>
</div>
<div class="sect2">
<h3 id="_组播被禁用">组播被禁用</h3>
<div class="paragraph">
<p>在某些情况下，因为特殊的运行环境，可能无法使用组播。在这种情况下，应该配置其他网络传输协议，例如在 TCP 上使用 <code>TCPPING</code> ，在亚马逊云上使用 <code>S3_PING</code> 。</p>
</div>
<div class="paragraph">
<p>有关 JGroups 更多传输方式，以及如何配置它们，请咨询 <a href="http://www.jgroups.org/manual/index.html#Discovery">JGroups文档</a> 。</p>
</div>
</div>
<div class="sect2">
<h3 id="_ipv6_错误">IPv6 错误</h3>
<div class="paragraph">
<p>如果在 IPv6 地址配置有难点，请通过 <code>java.net.preferIPv4Stack</code> 配置强制使用 IPv4:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-Djava.net.preferIPv4Stack=true</pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_infinispan_日志配置">Infinispan 日志配置</h3>
<div class="paragraph">
<p>在排除故障时，开启 Infinispan 和 JGroups 日志，将会给予很大的帮助。在 <code>classpath</code> 中添加 <code>vertx-default-jul-logging.properties</code> 文件（默认的JUL记录时），这是一个标准 java.util.loging（JUL） 配置文件。具体配置如下：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>org.infinispan.level=INFO
org.jgroups.level=INFO</pre>
</div>
</div>
<div class="paragraph">
<p>或</p>
</div>
<div class="listingblock">
<div class="content">
<pre>java.util.logging.ConsoleHandler.level=INFO
java.util.logging.FileHandler.level=INFO</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_infinispan_logging">Infinispan logging</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Infinispan 依赖与 JBoss Logging 。JBoss Logging 是一个与多种日志框架的桥接器。</p>
</div>
<div class="paragraph">
<p>JBoss Logging 能够自动检测使用 classpath 中 JARS 中的日志框架实现。</p>
</div>
<div class="paragraph">
<p>如果在 classpath 有多种日志框架，可以通过设置系统变量 <code>org.jboss.logging.provider</code> 来指定具体的实现，例子：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-Dorg.jboss.logging.provider=log4j2</pre>
</div>
</div>
<div class="paragraph">
<p>更多配置信息请参考 <a href="http://docs.jboss.org/hibernate/orm/4.3/topical/html/logging/Logging.html">JBoss Logging guide</a> 。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jgroups_日志配置">JGroups 日志配置</h2>
<div class="sectionbody">
<div class="paragraph">
<p>JGroups 默认采用 JDK Logging 实现。同时也支持 log4j 与 log4j2 ，如果相应的 jar 包 在 classpath 中。</p>
</div>
<div class="paragraph">
<p>如果想查阅更详细的信息，或实现自己的日志后端，请参考 <a href="http://www.jgroups.org/manual/index.html#Logging">JGroups 日志文档</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_shareddata_extensions">SharedData extensions</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_asyncmap_content_streams">AsyncMap content streams</h3>
<div class="paragraph">
<p>The <code>InfinispanAsyncMap</code> API allows to retrieve keys, values and entries as streams.
This can be useful if you need to go through the content of a large map for bulk processing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">InfinispanAsyncMap&lt;K, V&gt; infinispanAsyncMap = InfinispanAsyncMap.unwrap(asyncMap);
ReadStream&lt;K&gt; keyStream = infinispanAsyncMap.keyStream();
ReadStream&lt;V&gt; valueStream = infinispanAsyncMap.valueStream();
ReadStream&lt;Map.Entry&lt;K, V&gt;&gt; entryReadStream = infinispanAsyncMap.entryStream();</code></pre>
</div>
</div>
</div>
</div>
</div>
        

        
          <div id="footer">
            <div id="footer-text">
              
                上次更新时间 2018-10-16 18:24:41 CST
              
              
            </div>
          </div>
        
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse Vert.x</h2>
        <ul class="list-unstyled">
          <li><a href="https://vertx.tk/">主页</a></li>
          <li><a href="https://vertx.tk/download/">下载</a></li>
          <li><a href="https://vertx.tk/docs/">文档</a></li>
          <li><a href="https://github.com/vert-x3/wiki/wiki">维基</a></li>
          <li><a href="https://vertx.tk/blog/">博客</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Community</h2>
        <ul class="list-unstyled">
          <li><a href="https://vertx.tk/community/">Help &amp; Contributors</a></li>
          <li><a href="https://vertx.tk/materials/">Learning materials</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx">User Group</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx-dev">Developer Group</a></li>
          <li><a href="//shang.qq.com/wpa/qunwpa?idkey=587f58cacb9557e3291b46098e0fe09427b98a1c0f866da23c04c2762bc7e2ad">QQ群</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse</h2>
        <ul class="list-unstyled">
          <li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li>
          <li><a href="https://eclipse.org/legal/privacy.php">Privacy Policy</a></li>
          <li><a href="https://eclipse.org/legal/termsofuse.php">Terms of Use</a></li>
          <li><a href="https://eclipse.org/legal/copyright.php">Copyright Agent</a></li>
          <li><a href="http://www.eclipse.org/legal">Legal Resources</a></li>
        </ul>
      </div>

      <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright">
        <p>Eclipse Vert.x is open source and dual-licensed under the <a href="http://www.eclipse.org/legal/epl-v20.html">Eclipse Public License 2.0</a> and <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License 2.0</a>.</p>
        <p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>
        Design by <a href="https://www.michel-kraemer.com">Michel Kr&auml;mer</a>.</p>
        <div class="row">
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2">
            <a href="http://eclipse.org">
            <img class="logo eclipse-logo" src="https://vertx.tk/assets/eclipse_logo_grey_small.png" width="204" height="48">
            </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0">
            <a href="http://cloudbees.com">
            <img class="logo cloudbees-logo" src="https://vertx.tk/assets/Button-Built-on-CB-1-grey.png" width="180" height="48">
           </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler">
            <a href="http://www.ej-technologies.com/products/jprofiler/overview.html"
            style="text-decoration:none">
            <img class="logo jprofiler-logo" src="https://vertx.tk/assets/jprofiler-logo.png" width="48" height="48"><span class="jprofiler-logo">&nbsp; JPROFILER</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://vertx.tk/javascripts/bootstrap.min.js"></script>
<script src="https://vertx.tk/javascripts/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script src="https://vertx.tk/javascripts/sidebar.js"></script>


<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});
</script>
</body>
</html>

