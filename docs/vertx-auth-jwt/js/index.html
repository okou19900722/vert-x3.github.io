<!DOCTYPE html>
<html lang="en">
<head>
  <title>The JWT auth provider - Vert.x</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name="description">
  <link href="https://vertx.tk/stylesheets/docs.css" media="screen" rel="stylesheet">
  <link href="https://vertx.tk/stylesheets/font-awesome.min.css" media="screen" rel="stylesheet">
  <link href="https://vertx.tk/javascripts/styles/rainbow.min.css" media="screen" rel="stylesheet">
  <!-- IE 6-8 support of HTML 5 elements -->
  <!--[if lt IE 9]>
  <script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script>
  <![endif]-->

  <link rel="apple-touch-icon" sizes="57x57" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="https://vertx.tk/assets/favicons/vertx-favicon-7/manifest.json">
  <link rel="mask-icon" href="https://vertx.tk/assets/favicons/vertx-favicon-7/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#7d3194">
  <meta name="msapplication-TileImage" content="https://vertx.tk/assets/favicons/vertx-favicon-7/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel="stylesheet" type="text/css">
  <link rel="alternate" type="application/rss+xml" title="RSS"
     href="https://vertx.tk/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');
  </script>
  <style>
    .page-link-to-github {
      position: relative;
      z-index: 1;
      display: inline-block;
      border: 1px solid #782B90;
      border-radius: 5px;
      color: #782B90;
      font-size: 12px;
      padding: 4px 10px;
      text-decoration: none;
      background-color: #ffffff;
    }
    .page-link-to-github:hover {
      color: #ffffff;
      border-color: #ffffff;
      background-color: #782B90;
    }

    .page-link-to-github .github-icon {
      position: absolute;
      display: inline-block;
      width: 20px;
      height: 20px;
      /*background-position: -50px 0*/
      background: url('https://vertx.tk/assets/github.png') no-repeat 0 0;
    }

    @media (-webkit-min-device-pixel-ratio: 2),(min-resolution:192dpi) {
      .page-link-to-github .github-icon {
        background-image:url('https://vertx.tk/assets/github@2x.png');
        background-size: 150px auto
      }
    }

    .page-link-to-github:hover .github-icon {
      /*background-position: 0 0*/
      background-position: -100px 0
    }
    .text {
      text-decoration: underline
    }
    .page-link-to-github .text {
      padding-left: 27px
    }
    .text {
      padding-right: 8px
    }
    .page-link-to-github {
      float: right;
      top: 4px
    }

  </style>
</head>
<body>

<a href="http://www.reactivemanifesto.org/" id="reactive-manifesto-banner">
  <img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000"
    src="https://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png">
</a>

<a id="skippy" class="sr-only sr-only-focusable" href="#content"><div class="container"><span class="skiplink-text">Skip to main content</span></div></a>

<header class="navbar navbar-default navbar-static-top" id="top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#vertx-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="https://vertx.tk/" class="navbar-brand"><img alt="Brand" src="https://vertx.tk/assets/logo-sm.png"></a>
    </div>
    <nav class="collapse navbar-collapse" id="vertx-navbar-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://start.vertx.io">Starter</a></li>
        <li><a href="https://vertx.tk/download/">下载</a></li>
        <li><a href="https://vertx.tk/docs/">文档</a></li>
        <li><a href="https://github.com/vert-x3/wiki/wiki">维基</a></li>
        <li><a href="https://vertx.tk/community/">社区</a></li>
        <li><a href="https://vertx.tk/materials/">资料</a></li>
        <li><a href="https://vertx.tk/blog/">博客</a></li>
      </ul>
    </nav>
  </div>
</header>



  <div class="page-header" id="content">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1>The JWT auth provider</h1>
          
        </div>
      </div>
    </div>
  </div>



<div id="content">
  <div class="container docs-content">
    <div class="row">
      <div class="col-sm-12 col-md-push-9 col-md-3 hidden-xs hidden-sm">
        <div id="sidebar" data-spy="affix">
          <ul class="sectlevel1">
<li><a href="#_the_jwt_auth_provider">The JWT auth provider</a>
<ul class="sectlevel2">
<li><a href="#_loading_keys">Loading Keys</a></li>
<li><a href="#_read_only_tokens">Read only tokens</a></li>
</ul>
</li>
<li><a href="#_authn_authz_with_jwt">AuthN/AuthZ with JWT</a>
<ul class="sectlevel2">
<li><a href="#_authenticating_authn">Authenticating (AuthN)</a></li>
<li><a href="#_authorizing_authz">Authorizing (AuthZ)</a></li>
<li><a href="#_validating_tokens">Validating Tokens</a></li>
<li><a href="#_customizing_token_generation">Customizing Token Generation</a></li>
</ul>
</li>
</ul>
        </div>
      </div>
      <div class="col-sm-12 col-md-pull-3 col-md-9">
        <div class="toc hidden-md hidden-lg">
          <h2>Table of Contents</h2>
          <ul class="sectlevel1">
<li><a href="#_the_jwt_auth_provider">The JWT auth provider</a>
<ul class="sectlevel2">
<li><a href="#_loading_keys">Loading Keys</a></li>
<li><a href="#_read_only_tokens">Read only tokens</a></li>
</ul>
</li>
<li><a href="#_authn_authz_with_jwt">AuthN/AuthZ with JWT</a>
<ul class="sectlevel2">
<li><a href="#_authenticating_authn">Authenticating (AuthN)</a></li>
<li><a href="#_authorizing_authz">Authorizing (AuthZ)</a></li>
<li><a href="#_validating_tokens">Validating Tokens</a></li>
<li><a href="#_customizing_token_generation">Customizing Token Generation</a></li>
</ul>
</li>
</ul>
        </div>

  <a href="https://github.com/okou19900722/vertx-web-site-translation-chinese/tree/master/vertx-translation-stack/vertx-auth-jwt-translation"
     class="page-link-to-github"
     target="_blank"
     title="Edit this page on GitHub">
    <i class="github-icon"></i>
    <span class="text">编辑本页</span>
  </a>

        <div class="sect1">
<h2 id="_the_jwt_auth_provider">The JWT auth provider</h2>
<div class="sectionbody">
<div class="paragraph">
<p>这个组件包含了一个开箱即用的JWT实现。 要使用这个项目，将下面的依赖添加到构建描述符里的`dependencies`部分。</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maven (在 <code>pom.xml</code> 文件里):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;io.vertx&lt;/groupId&gt;
 &lt;artifactId&gt;vertx-auth-jwt&lt;/artifactId&gt;
 &lt;version&gt;3.6.0-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Gradle ( 在 <code>build.gradle</code> 文件里 ):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">compile 'io.vertx:vertx-auth-jwt:3.6.0-SNAPSHOT'</code></pre>
</div>
</div>
<div class="paragraph">
<p>JSON Web 令牌是一种简单的方法来发送明文信息（通常是URL），其内容可以被验证为是可信的。像下面的这些场景JWT是非常适用的：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>在一个单一的报名场景中，你想要有一个隔离的认证服务用可被信任的方式发送用户信息</p>
</li>
<li>
<p>无状态的Server API，非常适用于简单的页面应用</p>
</li>
<li>
<p>等等</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>在决定使用JWT之前，需要重点注意的是JWT并不加密payload，它仅对payload签名。
你不应该使用JWT发送任何私密信息，相反你应该发送是不是私密的但要被验证的信息。
举个例子，使用JWT发送一个签名过的用户id来表明这个用户已经登录了的做法非常对的。
相反发送一个用户的密码的做法是非常非常错误的。</p>
</div>
<div class="paragraph">
<p>JWT主要的优点有：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>它可以让你验证令牌的真实性</p>
</li>
<li>
<p>它有一个JSON结构，可以包含任何你想要的变量和大量的数据</p>
</li>
<li>
<p>它完全是无状态的</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>你可以使用 <code><a href="../../jsdoc/module-vertx-auth-jwt-js_jwt_auth-JWTAuth.html">JWTAuth</a></code> 来创建一个提供者的实例，并指定一个JSON对象的配置。</p>
</div>
<div class="paragraph">
<p>这是创建一个JWT auth提供者的示例代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">var JWTAuth = require("vertx-auth-jwt-js/jwt_auth");

var config = {
  "keyStore" : {
    "path" : "keystore.jceks",
    "password" : "secret"
  }
};

var provider = JWTAuth.create(vertx, config);</code></pre>
</div>
</div>
<div class="paragraph">
<p>JWT用法的典型流程是，在您的应用程序有一个终点颁发令牌，这个终点应在SSL模式下运行，终点这通过用户名和密码验证完请求用户之后，表示你将这样做生成令牌：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">var JWTAuth = require("vertx-auth-jwt-js/jwt_auth");

var config = {
  "keyStore" : {
    "path" : "keystore.jceks",
    "password" : "secret"
  }
};

var provider = JWTAuth.create(vertx, config);

// on the verify endpoint once you verify the identity of the user by its username/password
if ("paulo" == username &amp;&amp; "super_secret" == password) {
  var token = provider.generateToken({
    "sub" : "paulo"
  }, {
  });
  // now for any request to protected resources you should pass this string in the HTTP header Authorization as:
  // Authorization: Bearer &lt;token&gt;
}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_loading_keys">Loading Keys</h3>
<div class="paragraph">
<p>Loading keys can be performed in 3 different ways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using secrets (symmetric keys)</p>
</li>
<li>
<p>Using OpenSSL <code>pem</code> formatted files (pub/sec keys)</p>
</li>
<li>
<p>Using Java Keystore files (both symmetric and pub/sec keys)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is recommended to avoid java keystores, as java keystores are complex to generate and make many assumptions in order
to choose the right key for the authenticator.</p>
</div>
<div class="sect3">
<h4 id="_using_symmetric_keys">Using Symmetric Keys</h4>
<div class="paragraph">
<p>The default signature method for JWT&#8217;s is known as <code>HS256</code>. <code>HS</code> stands in this case for <code>HMAC Signature using SHA256</code>.</p>
</div>
<div class="paragraph">
<p>This is the simplest key to load. All you need is a secret that is shared between you and the 3rd party, for example
assume that the secret is: <code>keyboard cat</code> then you can configure your Auth as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">var JWTAuth = require("vertx-auth-jwt-js/jwt_auth");
var provider = JWTAuth.create(vertx, {
  "pubSecKeys" : [
    {
      "algorithm" : "HS256",
      "publicKey" : "keyboard cat",
      "symmetric" : true
    }
  ]
});

var token = provider.generateToken({
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this case the secret is configured as a public key, as it is a token that is known to both parties and you configure
your PubSec key as being symmetric.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_rsa_keys">Using RSA keys</h4>
<div class="paragraph">
<p>This section is by no means a manual on OpenSSL and a read on OpenSSL command line usage is advised. We will cover
how to generate the most common keys and how to use them with JWT auth.</p>
</div>
<div class="paragraph">
<p>Imagine that you would like to protect your application using the very common <code>RS256</code> JWT algorithm. Contrary to some
belief, 256 is not the key length but the hashing algorithm signature length. Any RSA key can be used with this JWT
algorithm. Here is an information table:</p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">"alg" Param Value</th>
<th class="tableblock halign-right valign-top">Digital Signature Algorithm</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>RS256</em></p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock"><strong>RSASSA-PKCS1-v1_5 using SHA-256</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>RS384</em></p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock"><strong>RSASSA-PKCS1-v1_5 using SHA-384</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><em>RS512</em></p></td>
<td class="tableblock halign-right valign-top"><p class="tableblock"><strong>RSASSA-PKCS1-v1_5 using SHA-512</strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>If you would like to generate a 2048bit RSA key pair, then you would do (please remember <strong>not</strong> to add a passphrase
otherwise you will not be able to read the private key in the JWT auth):</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl genrsa -out private.pem 2048</pre>
</div>
</div>
<div class="paragraph">
<p>You can observe that the key is correct as the file content is similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-----BEGIN RSA PRIVATE KEY-----
MIIEowIBAAKCAQEAxPSbCQY5mBKFDIn1kggvWb4ChjrctqD4nFnJOJk4mpuZ/u3h
...
e4k0yN3F1J1DVlqYWJxaIMzxavQsi9Hz4p2JgyaZMDGB6kGixkMo
-----END RSA PRIVATE KEY-----</pre>
</div>
</div>
<div class="paragraph">
<p>The standard JDK cannot read this file as is, so we <strong>must</strong> convert it to PKCS8 format first:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl pkcs8 -topk8 -inform PEM -in private.pem -out private_key.pem -nocrypt</pre>
</div>
</div>
<div class="paragraph">
<p>Now the new file <code>private_key.pem</code> which resembles the original one contains:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQDE9JsJBjmYEoUM
...
0fPinYmDJpkwMYHqQaLGQyg=
-----END PRIVATE KEY-----</pre>
</div>
</div>
<div class="paragraph">
<p>If we are verifying tokens only (you will only need the private_key.pem file) however at some point you will need to
issue tokens too, so you will a public key. In this case you need to extract the public key from the private key file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl rsa -in private.pem -outform PEM -pubout -out public.pem</pre>
</div>
</div>
<div class="paragraph">
<p>And you should see that the content of the file is similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAxPSbCQY5mBKFDIn1kggv
...
qwIDAQAB
-----END PUBLIC KEY-----</pre>
</div>
</div>
<div class="paragraph">
<p>Now you can use this to issue or validate tokens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Code not translatable</code></pre>
</div>
</div>
<div class="paragraph">
<p>Do note that all the lines <code>-----BEGIN &#8230;&#8203;</code> and <code>-----END&#8230;&#8203;</code> should be stripped from the string to be passed to the
configuration.</p>
</div>
</div>
<div class="sect3">
<h4 id="_using_ec_keys">Using EC keys</h4>
<div class="paragraph">
<p>Elliptic Curse keys are also supported, however the default JDK has some limitations on the features that can be used.</p>
</div>
<div class="paragraph">
<p>The usage is very similar to RSA, first you create a private key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl ecparam -name secp256r1 -genkey -out private.pem</pre>
</div>
</div>
<div class="paragraph">
<p>So you will get something similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-----BEGIN EC PARAMETERS-----
BggqhkjOPQMBBw==
-----END EC PARAMETERS-----
-----BEGIN EC PRIVATE KEY-----
MHcCAQEEIMZGaqZDTHL+IzFYEWLIYITXpGzOJuiQxR2VNGheq7ShoAoGCCqGSM49
AwEHoUQDQgAEG1O9LCrP6hg3Y9q68+LF0q48UcOkwVKE1ax0b56wjVusf3qnuFO2
/+XHKKhtzEavvFMeXRQ+ZVEqM0yGNb04qw==
-----END EC PRIVATE KEY-----</pre>
</div>
</div>
<div class="paragraph">
<p>However the JDK prefers PKCS8 format so we must convert:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl pkcs8 -topk8 -nocrypt -in private.pem -out private_key.pem</pre>
</div>
</div>
<div class="paragraph">
<p>Which will give you a key similar to this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>-----BEGIN PRIVATE KEY-----
MIGHAgEAMBMGByqGSM49AgEGCCqGSM49AwEHBG0wawIBAQQgxkZqpkNMcv4jMVgR
YshghNekbM4m6JDFHZU0aF6rtKGhRANCAAQbU70sKs/qGDdj2rrz4sXSrjxRw6TB
UoTVrHRvnrCNW6x/eqe4U7b/5ccoqG3MRq+8Ux5dFD5lUSozTIY1vTir
-----END PRIVATE KEY-----</pre>
</div>
</div>
<div class="paragraph">
<p>Using the private key you can already generate tokens:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Code not translatable</code></pre>
</div>
</div>
<div class="paragraph">
<p>So in order to validate the tokens you will need a public key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>openssl ec -in private.pem -pubout -out public.pem</pre>
</div>
</div>
<div class="paragraph">
<p>So you can do all operations with it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Code not translatable</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_the_jwt_keystore_file">The JWT keystore file</h4>
<div class="paragraph">
<p>If you prefer to use Java Keystores, then you can do it either.</p>
</div>
<div class="paragraph">
<p>auth提供者需要在类路径或文件系统上加载一个keystore文件，keystore文件要么有一个
<code><a href="https://docs.oracle.com/javase/8/docs/api/javax/crypto/Mac.html">javax.crypto.Mac</a></code>
要么有一个 <code><a href="https://docs.oracle.com/javase/8/docs/api/java/security/Signature.html">java.security.Signature</a></code> 用于签名和验证生成的令牌。</p>
</div>
<div class="paragraph">
<p>默认的情况下，实践将会查找这些别名，然而并不是所有的算法都需要存在。作为一个好的实践 <code>HS256</code> 应该存在：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>`HS256`:: HMAC using SHA-256 hash algorithm
`HS384`:: HMAC using SHA-384 hash algorithm
`HS512`:: HMAC using SHA-512 hash algorithm
`RS256`:: RSASSA using SHA-256 hash algorithm
`RS384`:: RSASSA using SHA-384 hash algorithm
`RS512`:: RSASSA using SHA-512 hash algorithm
`ES256`:: ECDSA using P-256 curve and SHA-256 hash algorithm
`ES384`:: ECDSA using P-384 curve and SHA-384 hash algorithm
`ES512`:: ECDSA using P-521 curve and SHA-512 hash algorithm</pre>
</div>
</div>
<div class="paragraph">
<p>当keystore没有被提供，执行将会回滚到一个不安全的模式同时签名并不会被验证，如果payload被外部的方法签名或加密后的情况下这是非常有用的。</p>
</div>
<div class="sect4">
<h5 id="_生成一个新的keystore文件">生成一个新的Keystore文件</h5>
<div class="paragraph">
<p>生成keystore文件唯一需要的工具是 <code>keytool</code> ，运行的时候，你可以指定你需要使用的算法：</p>
</div>
<div class="listingblock">
<div class="content">
<pre>keytool -genseckey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg HMacSHA256 -keysize 2048 -alias HS256 -keypass secret
keytool -genseckey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg HMacSHA384 -keysize 2048 -alias HS384 -keypass secret
keytool -genseckey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg HMacSHA512 -keysize 2048 -alias HS512 -keypass secret
keytool -genkey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg RSA -keysize 2048 -alias RS256 -keypass secret -sigalg SHA256withRSA -dname "CN=,OU=,O=,L=,ST=,C=" -validity 360
keytool -genkey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg RSA -keysize 2048 -alias RS384 -keypass secret -sigalg SHA384withRSA -dname "CN=,OU=,O=,L=,ST=,C=" -validity 360
keytool -genkey -keystore keystore.jceks -storetype jceks -storepass secret -keyalg RSA -keysize 2048 -alias RS512 -keypass secret -sigalg SHA512withRSA -dname "CN=,OU=,O=,L=,ST=,C=" -validity 360
keytool -genkeypair -keystore keystore.jceks -storetype jceks -storepass secret -keyalg EC -keysize 256 -alias ES256 -keypass secret -sigalg SHA256withECDSA -dname "CN=,OU=,O=,L=,ST=,C=" -validity 360
keytool -genkeypair -keystore keystore.jceks -storetype jceks -storepass secret -keyalg EC -keysize 384 -alias ES384 -keypass secret -sigalg SHA384withECDSA -dname "CN=,OU=,O=,L=,ST=,C=" -validity 360
keytool -genkeypair -keystore keystore.jceks -storetype jceks -storepass secret -keyalg EC -keysize 521 -alias ES512 -keypass secret -sigalg SHA512withECDSA -dname "CN=,OU=,O=,L=,ST=,C=" -validity 360</pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_read_only_tokens">Read only tokens</h3>
<div class="paragraph">
<p>If you need to consume JWT tokens issues by third parties you probably won&#8217;t have the private key with you, in that
case all you need to have is a public key im PEM format.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">var JWTAuth = require("vertx-auth-jwt-js/jwt_auth");

var config = {
  "pubSecKeys" : [
    {
      "algorithm" : "RS256",
      "publicKey" : "BASE64-ENCODED-PUBLIC_KEY"
    }
  ]
};

var provider = JWTAuth.create(vertx, config);</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_authn_authz_with_jwt">AuthN/AuthZ with JWT</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A common scenario when developing for example micro services is that you want you application to consume APIs. These
api&#8217;s are not meant to be consumed by humans so we should remove all the interactive part of authenticating the
consumer out of the picture.</p>
</div>
<div class="paragraph">
<p>In this scenario one can use HTTP as the protocol to consume this API and the HTTP protocol already defines that there
is a header <code>Authorization</code> that should be used for passing authorization information. In most cases you will see that
tokens are sent as bearer tokens, i.e.: <code>Authorization: Bearer some+base64+string</code>.</p>
</div>
<div class="sect2">
<h3 id="_authenticating_authn">Authenticating (AuthN)</h3>
<div class="paragraph">
<p>For this provider a user is authenticated if the token passes the signature checks and that the token is not expired.
For this reason it is imperative that private keys are kept private and not copy pasted across project since it would
be a security hole.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">// This string is what you see after the string "Bearer" in the
// HTTP Authorization header
jwtAuth.authenticate({
  "jwt" : "BASE64-ENCODED-STRING"
}, function (res, res_err) {
  if (res_err == null) {
    var theUser = res;
  } else {
    // Failed!
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a nutshell the provider is checking for several things:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>token signature is valid against internal private key</p>
</li>
<li>
<p>fields: <code>exp</code>, <code>iat</code>, <code>nbf</code>, <code>audience</code>, <code>issuer</code> are valid according to the config</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If all these are valid then the token is considered good and a user object is returned.</p>
</div>
<div class="paragraph">
<p>While the fields <code>exp</code>, <code>iat</code> and <code>nbf</code> are simple timestamp checks only <code>exp</code> can be configured to be ignored:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">// This string is what you see after the string "Bearer" in the
// HTTP Authorization header

// In this case we are forcing the provider to ignore the `exp` field
jwtAuth.authenticate({
  "jwt" : "BASE64-ENCODED-STRING",
  "options" : {
    "ignoreExpiration" : true
  }
}, function (res, res_err) {
  if (res_err == null) {
    var theUser = res;
  } else {
    // Failed!
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>In order to verify the <code>aud</code> field one needs to pass the options like before:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">// This string is what you see after the string "Bearer" in the
// HTTP Authorization header

// In this case we are forcing the provider to ignore the `exp` field
jwtAuth.authenticate({
  "jwt" : "BASE64-ENCODED-STRING",
  "options" : {
    "audience" : [
      "paulo@server.com"
    ]
  }
}, function (res, res_err) {
  if (res_err == null) {
    var theUser = res;
  } else {
    // Failed!
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the same for the issuer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">// This string is what you see after the string "Bearer" in the
// HTTP Authorization header

// In this case we are forcing the provider to ignore the `exp` field
jwtAuth.authenticate({
  "jwt" : "BASE64-ENCODED-STRING",
  "options" : {
    "issuer" : "mycorp.com"
  }
}, function (res, res_err) {
  if (res_err == null) {
    var theUser = res;
  } else {
    // Failed!
  }
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_authorizing_authz">Authorizing (AuthZ)</h3>
<div class="paragraph">
<p>Once a token is parsed and is valid we can use it to perform authorization tasks. The most simple is to verify if a
user has a specific authority. In this case one needs to to:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">user.isAuthorized("create-report", function (res, res_err) {
  if (res_err == null &amp;&amp; res) {
    // Yes the user can create reports
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default the provider will lookup under the key <code>permissions</code> but like the other providers one can extend the
concept to authorities to roles by using the <code>:</code> as a splitter, so <code>role:authority</code> can be used to lookup the token.</p>
</div>
<div class="paragraph">
<p>Since JWT are quite free form and there is no standard on where to lookup for the claims the location can be
configured to use something else than <code>permissions</code>, for example one can even lookup under a path like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-js" data-lang="js">Code not translatable</code></pre>
</div>
</div>
<div class="paragraph">
<p>So in this example we configure the JWT to work with Keycloak token format. In this case the claims will be checked
under the path <code>realm_access/roles</code> rather than <code>permissions</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_validating_tokens">Validating Tokens</h3>
<div class="paragraph">
<p>When the method <code>authenticate</code> is invoked, the token is validated against the <code>JWTOptions</code> provided during the
initialization. The validation performs the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>if <code>ignoreExpiration</code> (default is false) is false then the token is checked for expiration, this will check the
fields: <code>exp</code>, <code>iat</code> and <code>nbf</code>. Since sometimes clocks are not reliable, it is possible to configure some <code>leeway</code>
to be applied to the dates so we allow some grace period if the dates are outside the required limits.</p>
</li>
<li>
<p>if <code>audience</code> is provided, then the token <code>aud</code> is checked against the configured one and all configured audiences
must be in the token.</p>
</li>
<li>
<p>if <code>issuer</code> is configured, then the tokens <code>iss</code> is checked against the configured one.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Once these validations complete a JWTUser object is then returned, the object is configured with a reference to the
permission claims key provided in the configuration. This value is used later when doing authorization. The value
corresponds to the json path where authorities should be checked.</p>
</div>
</div>
<div class="sect2">
<h3 id="_customizing_token_generation">Customizing Token Generation</h3>
<div class="paragraph">
<p>In the same way tokens are validated, the generation is initially configured during the initialization.</p>
</div>
<div class="paragraph">
<p>When generating a token an optional extra parameter can be supplied to control the token generation, this is a
<code>JWTOptions</code> object. The token signature algorithm (default HS256) can be configured using the property <code>algorithm</code>.
In this case a lookup for a key that corresponds to the algorithm is performed and used to sign.</p>
</div>
<div class="paragraph">
<p>Token headers can be added by specifying any extra headers to be merged with the default ones using the options <code>headers</code>
property.</p>
</div>
<div class="paragraph">
<p>Sometimes it might be useful to issue tokens without a timestamp (test, development time for example) in this case the
property <code>noTimestamp</code> should be set to true (default false). This means that there is no <code>iat</code> field in the token.</p>
</div>
<div class="paragraph">
<p>Token expiration is controlled by the property <code>expiresInSeconds</code>, by default there is no expiration. Other control
fields <code>audience</code>, <code>issuer</code> and <code>subject</code> are then picked from the config is available and added to the token metadata.</p>
</div>
<div class="paragraph">
<p>Finally the token is signed and encoded in the correct format.</p>
</div>
<div class="paragraph">
<p>@author &lt;a href="mailto:julien@julienviet.com"&gt;Julien Viet&lt;/a&gt;
@author &lt;a href="http://tfox.org"&gt;Tim Fox&lt;/a&gt;
@author &lt;a href="mailto:pmlopes@gmail.com"&gt;Paulo Lopes&lt;/a&gt;</p>
</div>
</div>
</div>
</div>
        

        
          <div id="footer">
            <div id="footer-text">
              
                上次更新时间 2018-11-06 11:18:07 CST
              
              
            </div>
          </div>
        
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse Vert.x</h2>
        <ul class="list-unstyled">
          <li><a href="https://vertx.tk/">主页</a></li>
          <li><a href="https://vertx.tk/download/">下载</a></li>
          <li><a href="https://vertx.tk/docs/">文档</a></li>
          <li><a href="https://github.com/vert-x3/wiki/wiki">维基</a></li>
          <li><a href="https://vertx.tk/blog/">博客</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Community</h2>
        <ul class="list-unstyled">
          <li><a href="https://vertx.tk/community/">Help &amp; Contributors</a></li>
          <li><a href="https://vertx.tk/materials/">Learning materials</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx">User Group</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx-dev">Developer Group</a></li>
          <li><a href="//shang.qq.com/wpa/qunwpa?idkey=587f58cacb9557e3291b46098e0fe09427b98a1c0f866da23c04c2762bc7e2ad">QQ群</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse</h2>
        <ul class="list-unstyled">
          <li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li>
          <li><a href="https://eclipse.org/legal/privacy.php">Privacy Policy</a></li>
          <li><a href="https://eclipse.org/legal/termsofuse.php">Terms of Use</a></li>
          <li><a href="https://eclipse.org/legal/copyright.php">Copyright Agent</a></li>
          <li><a href="http://www.eclipse.org/legal">Legal Resources</a></li>
        </ul>
      </div>

      <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright">
        <p>Eclipse Vert.x is open source and dual-licensed under the <a href="http://www.eclipse.org/legal/epl-v20.html">Eclipse Public License 2.0</a> and <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License 2.0</a>.</p>
        <p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>
        Design by <a href="https://www.michel-kraemer.com">Michel Kr&auml;mer</a>.</p>
        <div class="row">
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2">
            <a href="http://eclipse.org">
            <img class="logo eclipse-logo" src="https://vertx.tk/assets/eclipse_logo_grey_small.png" width="204" height="48">
            </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0">
            <a href="http://cloudbees.com">
            <img class="logo cloudbees-logo" src="https://vertx.tk/assets/Button-Built-on-CB-1-grey.png" width="180" height="48">
           </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler">
            <a href="http://www.ej-technologies.com/products/jprofiler/overview.html"
            style="text-decoration:none">
            <img class="logo jprofiler-logo" src="https://vertx.tk/assets/jprofiler-logo.png" width="48" height="48"><span class="jprofiler-logo">&nbsp; JPROFILER</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://vertx.tk/javascripts/bootstrap.min.js"></script>
<script src="https://vertx.tk/javascripts/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script src="https://vertx.tk/javascripts/sidebar.js"></script>


<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});
</script>
</body>
</html>

