<!DOCTYPE html>
<html lang="en">
<head>
  <title>The OAuth2 auth provider - Vert.x</title>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta content="width=device-width, initial-scale=1.0" name="viewport">
  <meta content="Eclipse Vert.x is a tool-kit for building reactive applications on the JVM." name="description">
  <link href="https://vertx.tk/stylesheets/docs.css" media="screen" rel="stylesheet">
  <link href="https://vertx.tk/stylesheets/font-awesome.min.css" media="screen" rel="stylesheet">
  <link href="https://vertx.tk/javascripts/styles/rainbow.min.css" media="screen" rel="stylesheet">
  <!-- IE 6-8 support of HTML 5 elements -->
  <!--[if lt IE 9]>
  <script src="http://static.jboss.org/theme/js/libs/html5/pre3.6/html5.min.js"></script>
  <![endif]-->

  <link rel="apple-touch-icon" sizes="57x57" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="https://vertx.tk/assets/favicons/vertx-favicon-7/apple-touch-icon-180x180.png">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-32x32.png" sizes="32x32">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/android-chrome-192x192.png" sizes="192x192">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-96x96.png" sizes="96x96">
  <link rel="icon" type="image/png" href="https://vertx.tk/assets/favicons/vertx-favicon-7/favicon-16x16.png" sizes="16x16">
  <link rel="manifest" href="https://vertx.tk/assets/favicons/vertx-favicon-7/manifest.json">
  <link rel="mask-icon" href="https://vertx.tk/assets/favicons/vertx-favicon-7/safari-pinned-tab.svg" color="#5bbad5">
  <meta name="msapplication-TileColor" content="#7d3194">
  <meta name="msapplication-TileImage" content="https://vertx.tk/assets/favicons/vertx-favicon-7/mstile-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <link href="https://fonts.googleapis.com/css?family=Ubuntu:400,500,700,400italic" rel="stylesheet" type="text/css">
  <link rel="alternate" type="application/rss+xml" title="RSS"
     href="https://vertx.tk/feed.xml">
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-30144458-1', 'auto');
    ga('create', 'UA-71153120-1', 'auto', 'tracker');
    ga('send', 'pageview');
    ga('tracker.send', 'pageview');
  </script>
  <style>
    .page-link-to-github {
      position: relative;
      z-index: 1;
      display: inline-block;
      border: 1px solid #782B90;
      border-radius: 5px;
      color: #782B90;
      font-size: 12px;
      padding: 4px 10px;
      text-decoration: none;
      background-color: #ffffff;
    }
    .page-link-to-github:hover {
      color: #ffffff;
      border-color: #ffffff;
      background-color: #782B90;
    }

    .page-link-to-github .github-icon {
      position: absolute;
      display: inline-block;
      width: 20px;
      height: 20px;
      /*background-position: -50px 0*/
      background: url('https://vertx.tk/assets/github.png') no-repeat 0 0;
    }

    @media (-webkit-min-device-pixel-ratio: 2),(min-resolution:192dpi) {
      .page-link-to-github .github-icon {
        background-image:url('https://vertx.tk/assets/github@2x.png');
        background-size: 150px auto
      }
    }

    .page-link-to-github:hover .github-icon {
      /*background-position: 0 0*/
      background-position: -100px 0
    }
    .text {
      text-decoration: underline
    }
    .page-link-to-github .text {
      padding-left: 27px
    }
    .text {
      padding-right: 8px
    }
    .page-link-to-github {
      float: right;
      top: 4px
    }

  </style>
</head>
<body>

<a href="http://www.reactivemanifesto.org/" id="reactive-manifesto-banner">
  <img style="border: 0; position: fixed; right: 0; top:0; z-index: 9000"
    src="https://d379ifj7s9wntv.cloudfront.net/reactivemanifesto/images/ribbons/we-are-reactive-black-right.png">
</a>

<a id="skippy" class="sr-only sr-only-focusable" href="#content"><div class="container"><span class="skiplink-text">Skip to main content</span></div></a>

<header class="navbar navbar-default navbar-static-top" id="top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target="#vertx-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="https://vertx.tk/" class="navbar-brand"><img alt="Brand" src="https://vertx.tk/assets/logo-sm.png"></a>
    </div>
    <nav class="collapse navbar-collapse" id="vertx-navbar-collapse">
      <ul class="nav navbar-nav navbar-right">
        <li><a href="http://start.vertx.io">Starter</a></li>
        <li><a href="https://vertx.tk/download/">下载</a></li>
        <li><a href="https://vertx.tk/docs/">文档</a></li>
        <li><a href="https://github.com/vert-x3/wiki/wiki">维基</a></li>
        <li><a href="https://vertx.tk/community/">社区</a></li>
        <li><a href="https://vertx.tk/materials/">资料</a></li>
        <li><a href="https://vertx.tk/blog/">博客</a></li>
      </ul>
    </nav>
  </div>
</header>



  <div class="page-header" id="content">
    <div class="container">
      <div class="row">
        <div class="col-sm-12">
          <h1>The OAuth2 auth provider</h1>
          
        </div>
      </div>
    </div>
  </div>




<div id="content">
  <div class="container docs-content">
    <div class="row">
      <div class="col-sm-12 col-md-push-9 col-md-3 hidden-xs hidden-sm">
        <div id="sidebar" data-spy="affix">
          <ul class="sectlevel1">
<li><a href="#_the_oauth2_auth_provider">The OAuth2 auth provider</a>
<ul class="sectlevel2">
<li><a href="#_授权码_authorization_code_flow">授权码——Authorization Code Flow</a></li>
<li><a href="#_密码证书_password_credentials_flow">密码证书——Password Credentials Flow</a></li>
<li><a href="#_客户端证书_client_credentials_flow">客户端证书——Client Credentials Flow</a></li>
<li><a href="#_extensions">Extensions</a></li>
<li><a href="#_初探">初探</a></li>
<li><a href="#_openid_connect_discovery">OpenID Connect Discovery</a></li>
<li><a href="#_访问令牌对象">访问令牌对象</a></li>
<li><a href="#_其他通用oauth2的provider配置示例">其他通用OAuth2的Provider配置示例</a></li>
<li><a href="#_token_introspection">Token Introspection</a></li>
<li><a href="#_verifying_jwt_tokens">Verifying JWT tokens</a></li>
</ul>
</li>
<li><a href="#_role_based_access_control">Role Based Access Control</a>
<ul class="sectlevel2">
<li><a href="#_keycloak_jwt">Keycloak JWT</a></li>
<li><a href="#_microprofile_jwt_1_1_spec">MicroProfile JWT 1.1 spec</a></li>
</ul>
</li>
<li><a href="#_token_management">Token Management</a>
<ul class="sectlevel2">
<li><a href="#_check_if_it_is_expired">Check if it is expired</a></li>
<li><a href="#_refresh_token">Refresh token</a></li>
<li><a href="#_revoke_token">Revoke token</a></li>
<li><a href="#_introspect">Introspect</a></li>
<li><a href="#_logging_out">Logging out</a></li>
</ul>
</li>
</ul>
        </div>
      </div>
      <div class="col-sm-12 col-md-pull-3 col-md-9">
        <div class="toc hidden-md hidden-lg">
          <h2>Table of Contents</h2>
          <ul class="sectlevel1">
<li><a href="#_the_oauth2_auth_provider">The OAuth2 auth provider</a>
<ul class="sectlevel2">
<li><a href="#_授权码_authorization_code_flow">授权码——Authorization Code Flow</a></li>
<li><a href="#_密码证书_password_credentials_flow">密码证书——Password Credentials Flow</a></li>
<li><a href="#_客户端证书_client_credentials_flow">客户端证书——Client Credentials Flow</a></li>
<li><a href="#_extensions">Extensions</a></li>
<li><a href="#_初探">初探</a></li>
<li><a href="#_openid_connect_discovery">OpenID Connect Discovery</a></li>
<li><a href="#_访问令牌对象">访问令牌对象</a></li>
<li><a href="#_其他通用oauth2的provider配置示例">其他通用OAuth2的Provider配置示例</a></li>
<li><a href="#_token_introspection">Token Introspection</a></li>
<li><a href="#_verifying_jwt_tokens">Verifying JWT tokens</a></li>
</ul>
</li>
<li><a href="#_role_based_access_control">Role Based Access Control</a>
<ul class="sectlevel2">
<li><a href="#_keycloak_jwt">Keycloak JWT</a></li>
<li><a href="#_microprofile_jwt_1_1_spec">MicroProfile JWT 1.1 spec</a></li>
</ul>
</li>
<li><a href="#_token_management">Token Management</a>
<ul class="sectlevel2">
<li><a href="#_check_if_it_is_expired">Check if it is expired</a></li>
<li><a href="#_refresh_token">Refresh token</a></li>
<li><a href="#_revoke_token">Revoke token</a></li>
<li><a href="#_introspect">Introspect</a></li>
<li><a href="#_logging_out">Logging out</a></li>
</ul>
</li>
</ul>
        </div>

  <a href="https://github.com/okou19900722/vertx-web-site-translation-chinese/tree/master/vertx-translation-stack/vertx-auth-oauth2-translation"
     class="page-link-to-github"
     target="_blank"
     title="Edit this page on GitHub">
    <i class="github-icon"></i>
    <span class="text">编辑本页</span>
  </a>

        <div class="sect1">
<h2 id="_the_oauth2_auth_provider">The OAuth2 auth provider</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Vert.X的这个组件包含了标准的OAuth2的实现。若要在自己的项目中使用它，则需要在构建描述信息的_dependencies_节点中添加如下信息：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Maven (在 <code>pom.xml</code> 文件中):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-xml" data-lang="xml">&lt;dependency&gt;
 &lt;groupId&gt;io.vertx&lt;/groupId&gt;
 &lt;artifactId&gt;vertx-auth-oauth2&lt;/artifactId&gt;
 &lt;version&gt;3.6.0-SNAPSHOT&lt;/version&gt;
&lt;/dependency&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Gradle (在 <code>build.gradle</code> 文件中):</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-groovy" data-lang="groovy">compile 'io.vertx:vertx-auth-oauth2:3.6.0-SNAPSHOT'</code></pre>
</div>
</div>
<div class="paragraph">
<p>如果用户以第三方应用的方式访问想要的资源，OAuth2可以对这些用户进行授权，任何时候可以根据用户想要都有可能启用或禁用它的访问权限。</p>
</div>
<div class="paragraph">
<p>Vert.X中的OAuth2支持下边三种流程：</p>
</div>
<div class="ulist">
<ul>
<li>
<p>授权码流程（对服务器和App可持久化存储信息）</p>
</li>
<li>
<p>密码证书流程（之前的流程无法使用或开发阶段使用）</p>
</li>
<li>
<p>客户端证书流程（客户端可仅仅可凭借客户端整数申请访问令牌【Access Token】）</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The same code will work with OpenID Connect <a href="https://openid.net/connect/" class="bare">https://openid.net/connect/</a> servers and supports the Discovery protocol
as specified in <a href="http://openid.net/specs/openid-connect-discovery-1_0.html" class="bare">http://openid.net/specs/openid-connect-discovery-1_0.html</a> .</p>
</div>
<div class="sect2">
<h3 id="_授权码_authorization_code_flow">授权码——Authorization Code Flow</h3>
<div class="paragraph">
<p>授权码授权类型可以用来获取访问令牌（Access Token）和刷新令牌（Refresh Token），
对安全性要求高的客户端（Confidential Client）是很不错的（Optimized）一种方式。
作为一个基于重定向的流程，客户端必须能和资源拥有者的用户代理交互（通常是浏览器），
同时要能接受从授权服务器（Authorization Server）通过重定向发送过来的请求。</p>
</div>
<div class="paragraph">
<p>更多信息请参考 <a href="http://tools.ietf.org/html/draft-ietf-oauth-v2-31#section-4.1">Oauth2 specification, section 4.1</a> 。</p>
</div>
</div>
<div class="sect2">
<h3 id="_密码证书_password_credentials_flow">密码证书——Password Credentials Flow</h3>
<div class="paragraph">
<p>资源拥有者密码证书授权类型比较适合于这样一种情况：当资源拥有者和客户端之间有可信任的关系时使用，
如设备操作系统、或高特权应用。授权服务器应该在很特殊的情况时启用这种授权类型，并且仅仅当其他应用都不可见时允许使用这种类型。</p>
</div>
<div class="paragraph">
<p>这种类型对于客户端要获取资源拥有者证书（用户名和密码，通常使用交互式表单）是合适的。
它用于从已经存在的直接使用认证模式的如Basic或Digest的客户端向OAuth2认证方式迁移的时候，它会将证书直接转换成OAuth2中的访问令牌。</p>
</div>
<div class="paragraph">
<p>更多信息请参考 <a href="http://tools.ietf.org/html/draft-ietf-oauth-v2-31#section-4.3">Oauth2 specification, section 4.3</a> 。</p>
</div>
</div>
<div class="sect2">
<h3 id="_客户端证书_client_credentials_flow">客户端证书——Client Credentials Flow</h3>
<div class="paragraph">
<p>当客户端想要申请访问控制之下受保护的资源时，或者其他资源拥有者先前被授权服务器托管时（这种方式超出了本文范畴），客户端仅仅可以使用客户端证书（或者其他表示认证含义的信息）申请访问令牌。</p>
</div>
<div class="paragraph">
<p>客户端证书类型必须用于且仅用于机密客户端。</p>
</div>
<div class="paragraph">
<p>更多信息请参考 <a href="http://tools.ietf.org/html/draft-ietf-oauth-v2-31#section-4.4">Oauth2 specification, section 4.4</a> 。</p>
</div>
</div>
<div class="sect2">
<h3 id="_extensions">Extensions</h3>
<div class="paragraph">
<p>The provider supports RFC7523 an extension to allow server to server authorization based on JWT.</p>
</div>
</div>
<div class="sect2">
<h3 id="_初探">初探</h3>
<div class="paragraph">
<p>下边是基于GitHub中使用Vert.X的OAuth2 Provider的认证示例实现代码：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">OAuth2Auth oauth2 = OAuth2Auth.create(vertx, OAuth2FlowType.AUTH_CODE, new OAuth2ClientOptions()
  .setClientID("YOUR_CLIENT_ID")
  .setClientSecret("YOUR_CLIENT_SECRET")
  .setSite("https://github.com/login")
  .setTokenPath("/oauth/access_token")
  .setAuthorizationPath("/oauth/authorize")
);

// when there is a need to access a protected resource or call a protected method,
// call the authZ url for a challenge

String authorization_uri = oauth2.authorizeURL(new JsonObject()
  .put("redirect_uri", "http://localhost:8080/callback")
  .put("scope", "notifications")
  .put("state", "3(#0/!~"));

// when working with web application use the above string as a redirect url

// in this case GitHub will call you back in the callback uri one should now complete the handshake as:


String code = "xxxxxxxxxxxxxxxxxxxxxxxx"; // the code is provided as a url parameter by github callback call

oauth2.authenticate(new JsonObject().put("code", code).put("redirect_uri", "http://localhost:8080/callback"), res -&gt; {
  if (res.failed()) {
    // error, the code provided is not valid
  } else {
    // save the token and continue...
  }
});</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_授权码流程">授权码流程</h4>
<div class="paragraph">
<p>授权码流程主要包含两部分内容：
第一步，你的应用客户端向用户申请允许访问它们的数据，如果用户审批后，OAuth2服务器发送给客户端一个授权码；
第二步，客户端将这个授权码和客户端密钥放到POST请求中发送给授权服务器（Authority Server）得到访问令牌；</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">OAuth2ClientOptions credentials = new OAuth2ClientOptions()
  .setClientID("&lt;client-id&gt;")
  .setClientSecret("&lt;client-secret&gt;")
  .setSite("https://api.oauth.com");


// Initialize the OAuth2 Library
OAuth2Auth oauth2 = OAuth2Auth.create(vertx, OAuth2FlowType.AUTH_CODE, credentials);

// Authorization oauth2 URI
String authorization_uri = oauth2.authorizeURL(new JsonObject()
  .put("redirect_uri", "http://localhost:8080/callback")
  .put("scope", "&lt;scope&gt;")
  .put("state", "&lt;state&gt;"));

// Redirect example using Vert.x
response.putHeader("Location", authorization_uri)
  .setStatusCode(302)
  .end();

JsonObject tokenConfig = new JsonObject()
  .put("code", "&lt;code&gt;")
  .put("redirect_uri", "http://localhost:3000/callback");

// Callbacks
// Save the access token
oauth2.authenticate(tokenConfig, res -&gt; {
  if (res.failed()) {
    System.err.println("Access Token Error: " + res.cause().getMessage());
  } else {
    // Get the access token object (the authorization code is given from the previous step).
    User token = res.result();
  }
});</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_密码证书流程">密码证书流程</h4>
<div class="paragraph">
<p>资源拥有者密码证书授权类型比较适合于这样一种情况：当资源拥有者和客户端之间有可信任的关系时使用，
如设备操作系统、或高特权应用。授权服务器应该在很特殊的情况时启用这种授权类型，并且仅仅当其他应用都不可见时允许使用这种类型。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">OAuth2Auth oauth2 = OAuth2Auth.create(vertx, OAuth2FlowType.PASSWORD);

JsonObject tokenConfig = new JsonObject()
  .put("username", "username")
  .put("password", "password");

// Callbacks
// Save the access token
oauth2.authenticate(tokenConfig, res -&gt; {
  if (res.failed()) {
    System.err.println("Access Token Error: " + res.cause().getMessage());
  } else {
    // Get the access token object (the authorization code is given from the previous step).
    AccessToken token = (AccessToken) res.result();

    token.fetch("/users", res2 -&gt; {
      // the user object should be returned here...
    });
  }
});</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_客户端证书流程">客户端证书流程</h4>
<div class="paragraph">
<p>这种类型对于客户端要获取资源拥有者证书是合适的。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">OAuth2ClientOptions credentials = new OAuth2ClientOptions()
  .setClientID("&lt;client-id&gt;")
  .setClientSecret("&lt;client-secret&gt;")
  .setSite("https://api.oauth.com");


// Initialize the OAuth2 Library
OAuth2Auth oauth2 = OAuth2Auth.create(vertx, OAuth2FlowType.CLIENT, credentials);

JsonObject tokenConfig = new JsonObject();

// Callbacks
// Save the access token
oauth2.authenticate(tokenConfig, res -&gt; {
  if (res.failed()) {
    System.err.println("Access Token Error: " + res.cause().getMessage());
  } else {
    // Get the access token object (the authorization code is given from the previous step).
    User token = res.result();
  }
});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_openid_connect_discovery">OpenID Connect Discovery</h3>
<div class="paragraph">
<p>There is limited support for OpenID Discovery servers. Using OIDC Discovery will simplify the configuration of your
auth module into a single line of code, for example, consider setting up your auth using Google:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">OpenIDConnectAuth.discover(
  vertx,
  new OAuth2ClientOptions()
    .setSite("https://accounts.google.com")
    .setClientID("clientId"),
  res -&gt; {
    if (res.succeeded()) {
      // the setup call succeeded.
      // at this moment your auth is ready to use and
      // google signature keys are loaded so tokens can be decoded and verified.
    } else {
      // the setup failed.
    }
  });</code></pre>
</div>
</div>
<div class="paragraph">
<p>Behind the scenes a couple of actions are performed:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>HTTP get request to the <code>.well-known/openid-configuration</code> resource</p>
</li>
<li>
<p>Validation of the response <code>issuer</code> field as mandated by the spec (the issuer value must match the request one)</p>
</li>
<li>
<p>If the JWK uri is present, keys are loaded from the server and added to the auth keychain</p>
</li>
<li>
<p>the auth module is configure and returned to the user.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A couple of well known OpenID Connect Discovery providers are:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keycloak: <code><a href="http://keycloakhost:keycloakport/auth/realms/{realm}" class="bare">http://keycloakhost:keycloakport/auth/realms/{realm}</a></code></p>
</li>
<li>
<p>Google: <code><a href="https://accounts.google.com" class="bare">https://accounts.google.com</a></code></p>
</li>
<li>
<p>SalesForce: <code><a href="https://login.salesforce.com" class="bare">https://login.salesforce.com</a></code></p>
</li>
<li>
<p>Microsoft: <code><a href="https://login.windows.net/common" class="bare">https://login.windows.net/common</a></code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This and the given <code>client id</code> is enough to configure your auth provider object.</p>
</div>
</div>
<div class="sect2">
<h3 id="_访问令牌对象">访问令牌对象</h3>
<div class="paragraph">
<p>当一个令牌过期后你需要刷新令牌，OAuth2提供了访问令牌类AccessToken，它包含了很多实用的方法可以在令牌过期过后对令牌进行刷新。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">if (token.expired()) {
  // Callbacks
  token.refresh(res -&gt; {
    if (res.succeeded()) {
      // success
    } else {
      // error handling...
    }
  });
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>当你使用令牌访问完成过后想要注销，你可以撤销（Revoke）访问令牌和刷新令牌。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">token.revoke("access_token", res -&gt; {
  // Session ended. But the refresh_token is still valid.

  // Revoke the refresh_token
  token.revoke("refresh_token", res1 -&gt; System.out.println("token revoked."));
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_其他通用oauth2的provider配置示例">其他通用OAuth2的Provider配置示例</h3>
<div class="paragraph">
<p>For convenience there are several helpers to assist your with your configuration. Currently we provide:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Azure Active Directory <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/AzureADAuth.html">AzureADAuth</a></code></p>
</li>
<li>
<p>Box.com <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/BoxAuth.html">BoxAuth</a></code></p>
</li>
<li>
<p>Dropbox <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/DropboxAuth.html">DropboxAuth</a></code></p>
</li>
<li>
<p>Facebook <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/FacebookAuth.html">FacebookAuth</a></code></p>
</li>
<li>
<p>Foursquare <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/FoursquareAuth.html">FoursquareAuth</a></code></p>
</li>
<li>
<p>Github <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/GithubAuth.html">GithubAuth</a></code></p>
</li>
<li>
<p>Google <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/GoogleAuth.html">GoogleAuth</a></code></p>
</li>
<li>
<p>Instagram <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/InstagramAuth.html">InstagramAuth</a></code></p>
</li>
<li>
<p>Keycloak <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/KeycloakAuth.html">KeycloakAuth</a></code></p>
</li>
<li>
<p>LinkedIn <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/LinkedInAuth.html">LinkedInAuth</a></code></p>
</li>
<li>
<p>Mailchimp <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/MailchimpAuth.html">MailchimpAuth</a></code></p>
</li>
<li>
<p>Salesforce <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/SalesforceAuth.html">SalesforceAuth</a></code></p>
</li>
<li>
<p>Shopify <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/ShopifyAuth.html">ShopifyAuth</a></code></p>
</li>
<li>
<p>Soundcloud <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/SoundcloudAuth.html">SoundcloudAuth</a></code></p>
</li>
<li>
<p>Stripe <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/StripeAuth.html">StripeAuth</a></code></p>
</li>
<li>
<p>Twitter <code><a href="../../apidocs/io/vertx/ext/auth/oauth2/providers/TwitterAuth.html">TwitterAuth</a></code></p>
</li>
</ul>
</div>
<div class="sect3">
<h4 id="_jboss_keycloak">JBoss Keycloak</h4>
<div class="paragraph">
<p>When using this Keycloak the provider has knowledge on how to parse access tokens and extract grants from inside.
This information is quite valuable since it allows to do authorization at the API level, for example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">JsonObject keycloakJson = new JsonObject()
  .put("realm", "master")
  .put("realm-public-key", "MIIBIjANBgkqhk...wIDAQAB")
  .put("auth-server-url", "http://localhost:9000/auth")
  .put("ssl-required", "external")
  .put("resource", "frontend")
  .put("credentials", new JsonObject()
    .put("secret", "2fbf5e18-b923-4a83-9657-b4ebd5317f60"));

// Initialize the OAuth2 Library
OAuth2Auth oauth2 = KeycloakAuth.create(vertx, OAuth2FlowType.PASSWORD, keycloakJson);

// first get a token (authenticate)
oauth2.authenticate(new JsonObject().put("username", "user").put("password", "secret"), res -&gt; {
  if (res.failed()) {
    // error handling...
  } else {
    AccessToken token = (AccessToken) res.result();

    // now check for permissions
    token.isAuthorized("account:manage-account", r -&gt; {
      if (r.result()) {
        // this user is authorized to manage its account
      }
    });
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>We also provide a helper class for Keycloak so that we can we can easily retrieve decoded token and some necessary
data (e.g. <code>preferred_username</code>) from the Keycloak principal. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">JsonObject idToken = KeycloakHelper.idToken(principal);

// you can also retrieve some properties directly from the Keycloak principal
// e.g. `preferred_username`
String username = KeycloakHelper.preferredUsername(principal);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Please remember that Keycloak <strong>does</strong> implement OpenID Connect, so you can configure it just by using it&#8217;s discovery url:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">OpenIDConnectAuth.discover(
  vertx,
  new OAuth2ClientOptions()
    .setSite("http://server:port/auth/realms/your_realm")
    .setClientID("clientId"),
  res -&gt; {
    if (res.succeeded()) {
      // the setup call succeeded.
      // at this moment your auth is ready to use and
      // google signature keys are loaded so tokens can be decoded and verified.
    } else {
      // the setup failed.
    }
  });</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since you can deploy your Keycloak server anywhere, just replace <code>server:port</code> with the correct value and the <code>your_realm</code>
value with your application realm.</p>
</div>
</div>
<div class="sect3">
<h4 id="_google_server_to_server">Google Server to Server</h4>
<div class="paragraph">
<p>The provider also supports Server to Server or the RFC7523 extension. This is a feature present on Google with their
service account.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_token_introspection">Token Introspection</h3>
<div class="paragraph">
<p>Tokens can be introspected in order to assert that they are still valid. Although there is RFC7662 for this purpose
not many providers implement it. Instead there are variations also known as <code>TokenInfo</code> end points. The OAuth2
provider will accept both end points as a configuration. Currently we are known to work with <code>Google</code> and <code>Keycloak</code>.</p>
</div>
<div class="paragraph">
<p>Token introspection assumes that tokens are opaque, so they need to be validated on the provider server. Every time a
token is validated it requires a round trip to the provider. Introspection can be performed at the OAuth2 level or at
the User level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">oauth2.introspectToken("opaque string", res -&gt; {
  if (res.succeeded()) {
    // token is valid!
    AccessToken accessToken = res.result();
  }
});

// User level
token.introspect(res -&gt; {
  if (res.succeeded()) {
    // Token is valid!
  }
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_verifying_jwt_tokens">Verifying JWT tokens</h3>
<div class="paragraph">
<p>We&#8217;ve just covered how to introspect a token however when dealing with JWT tokens one can reduce the amount of trips
to the provider server thus enhancing your overall response times. In this case tokens will be verified using the
JWT protocol at your application side only. Verifying JWT tokens is cheaper and offers better performance, however
due to the stateless nature of JWTs it is not possible to know if a user is logged out and a token is invalid. For
this specific case one needs to use the token introspection if the provider supports it.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">oauth2.decodeToken("jwt-token", res -&gt; {
  if (res.succeeded()) {
    // token is valid!
    AccessToken accessToken = res.result();
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Until now we covered mostly authentication, although the implementation is relying party (that means that the real
authentication happens somewhere else), there is more you can do with the handler. For example you can also do
authorization if the provider is known to support JSON web tokens. This is a common feature if your provider is a
OpenId Connect provider or if the provider does support `access_token`s as JWTs.</p>
</div>
<div class="paragraph">
<p>Such provider is Keycloak that is a OpenId Connect implementation. In that case you will be able to perform
authorization in a very easy way.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_role_based_access_control">Role Based Access Control</h2>
<div class="sectionbody">
<div class="paragraph">
<p>OAuth2 is an AuthN protocol, however OpenId Connect adds JWTs to the token format which means that AuthZ can be encoded
at the token level. Currently there are 2 known JWT AuthZ known formats:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keycloak</p>
</li>
<li>
<p>MicroProfile JWT 1.1 spec</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_keycloak_jwt">Keycloak JWT</h3>
<div class="paragraph">
<p>Given that Keycloak does provide <code>JWT</code> `access_token`s one can authorize at two distinct levels:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>role</p>
</li>
<li>
<p>authority</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To distinct the two, the auth provider follows the same recommendations from the base user class, i.e.: use the`:` as
a separator for the two. It should be noted that both role and authorities do not need to be together, in the most
simple case an authority is enough.</p>
</div>
<div class="paragraph">
<p>In order to map to keycloak&#8217;s token format the following checks are performed:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If no role is provided, it is assumed to the the provider realm name</p>
</li>
<li>
<p>If the role is <code>realm</code> then the lookup happens in <code>realm_access</code> list</p>
</li>
<li>
<p>If a role is provided then the lookup happends in the <code>resource_access</code> list under the role name</p>
</li>
</ol>
</div>
<div class="sect3">
<h4 id="_check_for_a_specific_authorities">Check for a specific authorities</h4>
<div class="paragraph">
<p>Here is one example how you can perform authorization after the user has been loaded from the oauth2 handshake, for
example you want to see if the user can <code>print</code> in the current application:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">user.isAuthorized("print", res -&gt; {
  // in this case it is assumed that the role is the current application
  if (res.succeeded() &amp;&amp; res.result()) {
    // Yes the user can print
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>However this is quite specific, you might want to verify if the user can <code>add-user</code> to the whole system (the realm):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">user.isAuthorized("realm:add-user", res -&gt; {
  // the role is "realm"
  // the authority is "add-user"
  if (res.succeeded() &amp;&amp; res.result()) {
    // Yes the user can add users to the application
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Or if the user can access the <code>year-report</code> in the <code>finance</code> department:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">user.isAuthorized("finance:year-report", res -&gt; {
  // the role is "finance"
  // the authority is "year-report"
  if (res.succeeded() &amp;&amp; res.result()) {
    // Yes the user can access the year report from the finance department
  }
});</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_microprofile_jwt_1_1_spec">MicroProfile JWT 1.1 spec</h3>
<div class="paragraph">
<p>Another format in the form of a spec is the MP-JWT 1.1. This spec defines a JSON array of strings under the property
name <code>groups</code> that define the "groups" the token has an authority over.</p>
</div>
<div class="paragraph">
<p>In order to use this spec to assert AuthZ the right handler must be set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">oauth2Auth.rbacHandler(MicroProfileRBAC.create());</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_token_management">Token Management</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_check_if_it_is_expired">Check if it is expired</h3>
<div class="paragraph">
<p>Tokens are usually fetched from the server and cached, in this case when used later they might have already expired
and be invalid, you can verify if the token is still valid like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">boolean isExpired = user.expired();</code></pre>
</div>
</div>
<div class="paragraph">
<p>This call is totally offline, it could still happen that the Oauth2 server invalidated your token but you get a non
expired token result. The reason behind this is that the expiration is checked against the token expiration dates,
not before date and such values.</p>
</div>
</div>
<div class="sect2">
<h3 id="_refresh_token">Refresh token</h3>
<div class="paragraph">
<p>There are times you know the token is about to expire and would like to avoid to redirect the user again to the login
screen. In this case you can refresh the token. To refresh a token you need to have already a user and call:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">user.refresh(res -&gt; {
  if (res.succeeded()) {
    // the refresh call succeeded
  } else {
    // the token was not refreshed, a best practise would be
    // to forcefully logout the user since this could be a
    // symptom that you're logged out by the server and this
    // token is not valid anymore.
  }
});</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_revoke_token">Revoke token</h3>
<div class="paragraph">
<p>Since tokens can be shared across various applications you might want to disallow the usage of the current token by
any application. In order to do this one needs to revoke the token against the Oauth2 server:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">user.revoke("access_token", res -&gt; {
  if (res.succeeded()) {
    // the refresh call succeeded
  } else {
    // the token was not refreshed, a best practise would be
    // to forcefully logout the user since this could be a
    // symptom that you're logged out by the server and this
    // token is not valid anymore.
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is important to note that this call requires a token type. The reason is because some providers will return more
than one token e.g.:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>id_token</p>
</li>
<li>
<p>refresh_token</p>
</li>
<li>
<p>access_token</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So one needs to know what token to invalidate. It should be obvious that if you invalidate the <code>refresh_token</code> you&#8217;re
still logged in but you won&#8217;t be able to refresh anymore, which means that once the token expires you need to redirect
the user again to the login page.</p>
</div>
</div>
<div class="sect2">
<h3 id="_introspect">Introspect</h3>
<div class="paragraph">
<p>Introspect a token is similar to a expiration check, however one needs to note that this check is fully online. This
means that the check happens on the OAuth2 server.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">user.introspect(res -&gt; {
  if (res.succeeded()) {
    // the introspection call succeeded
  } else {
    // the token failed the introspection. You should proceed
    // to logout the user since this means that this token is
    // not valid anymore.
  }
});</code></pre>
</div>
</div>
<div class="paragraph">
<p>Important note is that even if the <code>expired()</code> call is <code>true</code> the return from the <code>introspect</code> call can still be an
error. This is because the OAuth2 might have received a request to invalidate the token or a loggout in between.</p>
</div>
</div>
<div class="sect2">
<h3 id="_logging_out">Logging out</h3>
<div class="paragraph">
<p>Logging out is not a <code>Oauth2</code> feature but it is present on <code>OpenID Connect</code> and most providers do support some sort
of logging out. This provider also covers this area if the configuration is enough to let it make the call. For the
user this is as simple as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">user.logout(res -&gt; {
  if (res.succeeded()) {
    // the logout call succeeded
  } else {
    // the user might not have been logged out
    // to know why:
    System.out.println(res.cause());
  }
});</code></pre>
</div>
</div>
</div>
</div>
</div>
        

        
          <div id="footer">
            <div id="footer-text">
              
                上次更新时间 2018-10-16 18:23:38 CST
              
              
            </div>
          </div>
        
      </div>
    </div>
  </div>
</div>

<footer>
  <div class="container">
    <div class="row">
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse Vert.x</h2>
        <ul class="list-unstyled">
          <li><a href="https://vertx.tk/">主页</a></li>
          <li><a href="https://vertx.tk/download/">下载</a></li>
          <li><a href="https://vertx.tk/docs/">文档</a></li>
          <li><a href="https://github.com/vert-x3/wiki/wiki">维基</a></li>
          <li><a href="https://vertx.tk/blog/">博客</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Community</h2>
        <ul class="list-unstyled">
          <li><a href="https://vertx.tk/community/">Help &amp; Contributors</a></li>
          <li><a href="https://vertx.tk/materials/">Learning materials</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx">User Group</a></li>
          <li><a href="https://groups.google.com/forum/?fromgroups#!forum/vertx-dev">Developer Group</a></li>
          <li><a href="//shang.qq.com/wpa/qunwpa?idkey=587f58cacb9557e3291b46098e0fe09427b98a1c0f866da23c04c2762bc7e2ad">QQ群</a></li>
        </ul>
      </div>
      <div class="col-xs-4 col-sm-4 col-md-2 col-lg-2">
        <h2>Eclipse</h2>
        <ul class="list-unstyled">
          <li><a href="http://www.eclipse.org/">Eclipse Foundation</a></li>
          <li><a href="https://eclipse.org/legal/privacy.php">Privacy Policy</a></li>
          <li><a href="https://eclipse.org/legal/termsofuse.php">Terms of Use</a></li>
          <li><a href="https://eclipse.org/legal/copyright.php">Copyright Agent</a></li>
          <li><a href="http://www.eclipse.org/legal">Legal Resources</a></li>
        </ul>
      </div>

      <div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 copyright">
        <p>Eclipse Vert.x is open source and dual-licensed under the <a href="http://www.eclipse.org/legal/epl-v20.html">Eclipse Public License 2.0</a> and <a href="https://www.apache.org/licenses/LICENSE-2.0.html">Apache License 2.0</a>.</p>
        <p>This website is licensed under the <a href="http://creativecommons.org/licenses/by-sa/3.0/">CC BY-SA 3.0 License</a>.<br>
        Design by <a href="https://www.michel-kraemer.com">Michel Kr&auml;mer</a>.</p>
        <div class="row">
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-2">
            <a href="http://eclipse.org">
            <img class="logo eclipse-logo" src="https://vertx.tk/assets/eclipse_logo_grey_small.png" width="204" height="48">
            </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-1 col-lg-offset-0">
            <a href="http://cloudbees.com">
            <img class="logo cloudbees-logo" src="https://vertx.tk/assets/Button-Built-on-CB-1-grey.png" width="180" height="48">
           </a>
          </div>
          <div class="col-sm-12 col-md-5 col-md-offset-7 jprofiler">
            <a href="http://www.ej-technologies.com/products/jprofiler/overview.html"
            style="text-decoration:none">
            <img class="logo jprofiler-logo" src="https://vertx.tk/assets/jprofiler-logo.png" width="48" height="48"><span class="jprofiler-logo">&nbsp; JPROFILER</span>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="https://vertx.tk/javascripts/bootstrap.min.js"></script>
<script src="https://vertx.tk/javascripts/highlight.pack.js"></script>
<script>hljs.initHighlightingOnLoad();</script>



<script src="https://vertx.tk/javascripts/sidebar.js"></script>


<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.0.3/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#64386b",
      "text": "#ffcdfd"
    },
    "button": {
      "background": "transparent",
      "text": "#f8a8ff",
      "border": "#f8a8ff"
    }
  },
  "content": {
    "message": "This website uses anonymous cookies to ensure we provide you the best experience. ",
    "link": "Opt out!",
    "href": "https://tools.google.com/dlpage/gaoptout/"
  }
})});
</script>
</body>
</html>

